<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Kmilo</title>
<script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;overflow:hidden;background:#08000f;}
body{font-family:-apple-system,BlinkMacSystemFont,'Apple SD Gothic Neo','Noto Sans KR',sans-serif;color:#fff;-webkit-font-smoothing:antialiased;font-size:12px;line-height:1.5;}
#root{width:100vw;height:100vh;display:flex;justify-content:center;align-items:center;background:#06000c;}
.phone{width:min(390px,100vw);height:100dvh;position:relative;overflow:clip;display:flex;flex-direction:column;background:#08000f;}
::-webkit-scrollbar{display:none;}*{-ms-overflow-style:none;scrollbar-width:none;}
.sc{overflow-y:auto;-webkit-overflow-scrolling:touch;}
:root{--g1:linear-gradient(135deg,#7c3aed,#ec4899);--g2:linear-gradient(135deg,#a855f7,#f472b6);--g3:rgba(124,58,237,.12);--p:#a855f7;--pk:#ec4899;--dim:rgba(255,255,255,.32);}
@keyframes fi{from{opacity:0}to{opacity:1}}
@keyframes fu{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
@keyframes su{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
@keyframes rip{0%{transform:scale(1);opacity:.6}100%{transform:scale(4.5);opacity:0}}
@keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
@keyframes bubblein{from{opacity:0;transform:scale(.85)}to{opacity:1;transform:scale(1)}}
@keyframes gradshift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
@keyframes dotpulse{0%{transform:scale(1);box-shadow:0 0 0 0 rgba(168,85,247,.8)}60%{transform:scale(1.4);box-shadow:0 0 0 6px rgba(168,85,247,0)}100%{transform:scale(1);box-shadow:0 0 0 0 rgba(168,85,247,0)}}
@keyframes dotbeat{0%,100%{transform:scale(1)}50%{transform:scale(1.12)}}
.dlike{width:12px;height:12px;border-radius:99px;display:inline-block;transition:background .15s;}
.dlike.on{background:linear-gradient(135deg,#7c3aed,#ec4899);animation:dotpulse .9s ease-out infinite;}
.dlike.off{background:rgba(255,255,255,.22);animation:dotbeat 2.2s ease-in-out infinite;}
.af{animation:fi .25s ease both}
.au{animation:fu .3s ease both}
.asu{animation:su .38s cubic-bezier(.16,1,.3,1) both}
.spin{animation:spin .8s linear infinite;display:inline-block}
.btn{display:flex;align-items:center;justify-content:center;cursor:pointer;border:none;background:none;color:inherit;font-family:inherit;font-size:inherit;transition:opacity .12s;}
.btn:active{opacity:.35;}
.gbtn{background:linear-gradient(135deg,#7c3aed,#ec4899);border:none;color:#fff;cursor:pointer;font-family:inherit;font-weight:700;transition:opacity .14s;display:flex;align-items:center;justify-content:center;}
.gbtn:active{opacity:.7;}
.inp{background:none;border:none;border-bottom:1px solid rgba(255,255,255,.12);color:#fff;outline:none;width:100%;padding:10px 0;font-size:12px;font-family:inherit;}
.inp:focus{border-bottom-color:rgba(168,85,247,.7);}
.inp::placeholder{color:#2a2a2a;}
textarea.inp{resize:none;}
.tabbar{flex-shrink:0;background:#08000f;border-top:1px solid rgba(168,85,247,.12);height:calc(54px + env(safe-area-inset-bottom));padding-bottom:env(safe-area-inset-bottom);display:flex;overflow:visible;position:relative;}
.kmn{font-size:11px;font-weight:700;background:linear-gradient(135deg,#a855f7,#f472b6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.fab{width:48px;height:48px;border-radius:99px;background:linear-gradient(135deg,#a855f7,#f472b6);display:flex;align-items:center;justify-content:center;font-size:26px;font-weight:300;color:#fff;box-shadow:0 4px 20px rgba(168,85,247,.5);margin-top:-22px;position:relative;z-index:10;}

.gtxt{background:linear-gradient(135deg,#a855f7,#f472b6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.sep{height:1px;background:rgba(168,85,247,.1);}
.wmap{position:absolute;top:0;left:0;width:220%;height:100%;opacity:.05;pointer-events:none;transition:transform .8s cubic-bezier(.25,.46,.45,.94);}
.pin{position:absolute;width:6px;height:6px;border-radius:50%;background:linear-gradient(135deg,#7c3aed,#ec4899);transform:translate(-50%,-50%);z-index:3;box-shadow:0 0 8px rgba(168,85,247,.7);}
.pin::before,.pin::after{content:'';position:absolute;inset:-4px;border-radius:50%;border:1.5px solid rgba(168,85,247,.45);}
.pin::before{animation:rip 2.2s ease-out infinite;}
.pin::after{animation:rip 2.2s .75s ease-out infinite;}

/* 워터마크 제거 */
iframe,[class*="Sandbox-watermark"],#codesandbox-hint{display:none!important;visibility:hidden!important;opacity:0!important;pointer-events:none!important;}
.tabbar{padding-bottom:env(safe-area-inset-bottom)!important;}

@keyframes spin{to{transform:rotate(360deg)}}
</style>

<!-- Firebase SDK -->
<script type="module" id="firebase-init">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.10.0/firebase-app.js';
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/12.10.0/firebase-auth.js';
  import { getFirestore, collection, doc, setDoc, getDoc, getDocs, addDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp, increment, arrayUnion } from 'https://www.gstatic.com/firebasejs/12.10.0/firebase-firestore.js';
  import { getAnalytics, logEvent } from 'https://www.gstatic.com/firebasejs/12.10.0/firebase-analytics.js';


  const firebaseConfig = {
    apiKey: "AIzaSyBDLnzXq1xkzs1XpP3muU5t13K6Ha71Ygs",
    authDomain: "kmilo-cfd52.firebaseapp.com",
    projectId: "kmilo-cfd52",
    storageBucket: "kmilo-cfd52.firebasestorage.app",
    messagingSenderId: "896901708380",
    appId: "1:896901708380:web:9075b3e9a62042393ac499",
    measurementId: "G-X83HPQTZ8Q"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const analytics = getAnalytics(app);


  // 전역으로 노출 (Babel script에서 사용)
  window.FB = { auth, db, analytics,
    createUserWithEmailAndPassword, signInWithEmailAndPassword,
    onAuthStateChanged, signOut,
    collection, doc, setDoc, getDoc, getDocs, addDoc, updateDoc, deleteDoc,
    onSnapshot, query, orderBy, serverTimestamp, increment, arrayUnion, logEvent
  };
  window.FB_READY = true;
  window.dispatchEvent(new Event('fb-ready'));
</script>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const {useState,useEffect,useRef,useMemo,createContext,useContext} = React;

const LANGS={
  ko:{login:'로그인',signup:'회원가입',email:'이메일',pw:'비밀번호',name:'이름',loginBtn:'로그인 →',signupBtn:'시작하기 →',loading:'처리 중…',testAcc:'테스트 계정',errEmpty:'이메일과 비밀번호를 입력하세요.',errWrong:'이메일 또는 비밀번호가 올바르지 않습니다.',errAll:'모든 항목을 입력하세요.',errPw:'비밀번호 6자 이상',connDist:'연결 거리',curLoc:'현재 위치',countries:'개국',allView:'전체 보기',director:'디렉터',relayJourney:'릴레이 여정',notifTitle:'알림',close:'닫기',back:'← 뒤로',explore:'탐색',noResult:'결과 없음',trending:'인기 릴레이',legacy:'레거시',totalDist:'총 연결 거리',globalRank:'글로벌 순위',myRelay:'내 릴레이',profile:'프로필',edit:'편집',done:'완료',logout:'로그아웃',newRelay:'새 릴레이',selectVideo:'영상 선택 →',uploadDesc:'60초 이내 영상으로 릴레이를 시작하세요.',title:'제목',descTxt:'설명',category:'카테고리',prevStep:'← 이전',startRelay:'릴레이 시작 →',uploading:'업로드 중…',relayStarted:'릴레이 시작!',relayStartedDesc:'씨앗이 심어졌습니다.',goHome:'홈으로 →',notification:'알림',home:'홈',tab_explore:'탐색',tab_legacy:'레거시',tab_profile:'프로필',likes:'좋아요',seeTranslation:'번역 보기',translated:'번역됨',translating:'번역 중…',comments:'댓글',addComment:'댓글 추가…',send:'전송',langAuto:'자동 감지',expiresIn:' 후 만료',expired:'만료됨',privateLabel:'쪽지',publicLabel:'무물 게시',bubbleSection:'버블',join:'참여',joining:'참여하기',joinDone:'참여 완료!',joinedRelay:'릴레이에 합류했습니다.',inbox:'질문함',unanswered:'미답변',unansweredLeft:'남음',noQuestions:'받은 질문이 없습니다',answeredDone:'답변 완료',publicAnswerDone:'공개 답변 완료',privateAnswerDone:'비공개 답변 완료',privateReply:'비공개',publicReply:'공개',toAskerOnly:'질문자에게만',postOnCard:'카드에 게시',publicAnswer:'공개 답변',privateAnswer:'비공개 답변',publicAnswerHint:'공개 답변은 버블 카드에 질문과 함께 표시됩니다',privateAnswerHint:'질문자에게만 비공개로 전달됩니다',publicPost:'공개 게시',privateSend:'비공개 전송',publicAnswerPlaceholder:'공개 답변을 입력하세요…',privateAnswerPlaceholder:'비공개 답변을 입력하세요…',bubbleLabel:'버블',noPublicBubble:'아직 공개된 버블이 없습니다',ownBubbleHint:'공개 답변하면 여기에 카드로 표시돼요',publicBadge:'공개',timeLeft:'남음',noRelay:'아직 릴레이가 없습니다',askTitle:'에게 질문',askHint:'24시간 후 사라집니다',askSend:'질문 보내기 →',askPlaceholder:'궁금한 것을 뭐든지 물어보세요...',cancel:'취소',statRelay:'릴레이',statFollower:'팔로워'},
  en:{login:'Login',signup:'Sign Up',email:'Email',pw:'Password',name:'Name',loginBtn:'Login →',signupBtn:'Get Started →',loading:'Loading…',testAcc:'Test accounts',errEmpty:'Enter email and password.',errWrong:'Wrong email or password.',errAll:'Fill all fields.',errPw:'Password min 6 chars',connDist:'Distance',curLoc:'Location',countries:' countries',allView:'View all',director:'Director',relayJourney:'Relay journey',notifTitle:'Notifications',close:'Close',back:'← Back',explore:'Explore',noResult:'No results',trending:'Trending',legacy:'Legacy',totalDist:'Total distance',globalRank:'Global rank',myRelay:'My relays',profile:'Profile',edit:'Edit',done:'Done',logout:'Logout',newRelay:'New Relay',selectVideo:'Select video →',uploadDesc:'Start a relay with a video under 60 seconds.',title:'Title',descTxt:'Description',category:'Category',prevStep:'← Back',startRelay:'Start relay →',uploading:'Uploading…',relayStarted:'Relay started!',relayStartedDesc:'Your seed is planted.',goHome:'Go home →',notification:'Notification',home:'Home',tab_explore:'Explore',tab_legacy:'Legacy',tab_profile:'Profile',likes:'likes',seeTranslation:'Translate',translated:'Translated',translating:'Translating…',comments:'Comments',addComment:'Add comment…',send:'Send',langAuto:'Auto-detected',expiresIn:' left',expired:'Expired',privateLabel:'DM',publicLabel:'Q&A Post',bubbleSection:'Bubble',join:'Join',joining:'Join Relay',joinDone:'Joined!',joinedRelay:'You joined the relay.',inbox:'Inbox',unanswered:'Unanswered',unansweredLeft:'left',noQuestions:'No questions yet',answeredDone:'Answered',publicAnswerDone:'Public answer sent',privateAnswerDone:'Private answer sent',privateReply:'Private',publicReply:'Public',toAskerOnly:'To asker only',postOnCard:'Post on card',publicAnswer:'Public Reply',privateAnswer:'Private Reply',publicAnswerHint:'Public answer will appear on the bubble card.',privateAnswerHint:'Only the asker will see this.',publicPost:'Post publicly',privateSend:'Send privately',publicAnswerPlaceholder:'Write a public answer…',privateAnswerPlaceholder:'Write a private answer…',bubbleLabel:'Bubble',noPublicBubble:'No public bubbles yet',ownBubbleHint:'Public answers will appear as cards here',publicBadge:'Public',timeLeft:'left',noRelay:'No relays yet',askTitle:' — Ask',askHint:'Disappears in 24 hours',askSend:'Send question →',askPlaceholder:'Ask anything…',cancel:'Cancel',statRelay:'Relay',statFollower:'Followers'},
  ja:{login:'ログイン',signup:'新規登録',email:'メール',pw:'パスワード',name:'名前',loginBtn:'ログイン →',signupBtn:'始める →',loading:'処理中…',testAcc:'テストアカウント',errEmpty:'メールとパスワードを入力。',errWrong:'メールかパスワードが違います。',errAll:'全項目を入力してください。',errPw:'パスワード6文字以上',connDist:'接続距離',curLoc:'現在地',countries:'か国',allView:'全部見る',director:'ディレクター',relayJourney:'リレーの旅',notifTitle:'通知',close:'閉じる',back:'← 戻る',explore:'探索',noResult:'結果なし',trending:'人気',legacy:'レガシー',totalDist:'総接続距離',globalRank:'グローバルランク',myRelay:'自分のリレー',profile:'プロフィール',edit:'編集',done:'完了',logout:'ログアウト',newRelay:'新しいリレー',selectVideo:'動画を選択 →',uploadDesc:'60秒以内の動画でリレーを始めましょう。',title:'タイトル',descTxt:'説明',category:'カテゴリー',prevStep:'← 前へ',startRelay:'リレーを開始 →',uploading:'アップロード中…',relayStarted:'リレー開始！',relayStartedDesc:'種が植えられました。',goHome:'ホームへ →',notification:'通知',home:'ホーム',tab_explore:'探索',tab_legacy:'レガシー',tab_profile:'プロフィール',likes:'いいね',seeTranslation:'翻訳',translated:'翻訳済み',translating:'翻訳中…',comments:'コメント',addComment:'コメントを追加…',send:'送信',langAuto:'自動検出',expiresIn:' 残り',expired:'期限切れ',privateLabel:'DM',publicLabel:'Q&A投稿',bubbleSection:'バブル',join:'参加',joining:'参加する',joinDone:'参加完了！',joinedRelay:'リレーに参加しました。',inbox:'質問箱',unanswered:'未回答',unansweredLeft:'残り',noQuestions:'質問はまだありません',answeredDone:'回答済み',publicAnswerDone:'公開回答完了',privateAnswerDone:'非公開回答完了',privateReply:'非公開',publicReply:'公開',toAskerOnly:'質問者のみに',postOnCard:'カードに投稿',publicAnswer:'公開回答',privateAnswer:'非公開回答',publicAnswerHint:'公開回答はバブルカードに表示されます',privateAnswerHint:'質問者のみに非公開で届きます',publicPost:'公開投稿',privateSend:'非公開送信',publicAnswerPlaceholder:'公開回答を入力…',privateAnswerPlaceholder:'非公開回答を入力…',bubbleLabel:'バブル',noPublicBubble:'まだ公開バブルはありません',ownBubbleHint:'公開回答するとここにカードが表示されます',publicBadge:'公開',timeLeft:'残り',noRelay:'まだリレーがありません',askTitle:'への質問',askHint:'24時間後に消えます',askSend:'質問を送る →',askPlaceholder:'何でも聞いてみてください…',cancel:'キャンセル',statRelay:'リレー',statFollower:'フォロワー'},
};
const detectLang=()=>{const l=(navigator.language||'en').split('-')[0];return LANGS[l]?l:'en';};
const LangCtx=createContext({lang:'en',t:LANGS.en,setLang:()=>{}});
const useT=()=>useContext(LangCtx);

const WorldMap=({tx=0})=>(
  <svg className="wmap" style={{transform:`translateX(${tx}%)`}} viewBox="0 0 1000 500" preserveAspectRatio="xMidYMid slice" fill="none" stroke="#a855f7" strokeWidth=".6">
    {[0,83,166,250,333,416,500].map(y=><line key={y} x1="0" y1={y} x2="1000" y2={y} strokeWidth=".2" opacity=".35"/>)}
    {[0,100,200,300,400,500,600,700,800,900,1000].map(x=><line key={x} x1={x} y1="0" x2={x} y2="500" strokeWidth=".2" opacity=".35"/>)}
    <path d="M120,60 L200,55 L240,80 L245,130 L220,165 L195,185 L185,215 L168,232 L148,222 L138,200 L118,190 L98,168 L88,138 L98,108Z"/>
    <path d="M82,202 L98,197 L108,212 L118,234 L113,258 L98,272 L83,262 L73,242Z"/>
    <path d="M173,260 L203,256 L223,272 L233,302 L228,342 L213,382 L198,422 L183,442 L168,422 L158,392 L153,352 L158,312 L164,280Z"/>
    <path d="M430,58 L472,53 L502,63 L512,83 L502,103 L482,113 L462,118 L442,108 L426,88Z"/>
    <path d="M440,168 L492,163 L532,173 L552,198 L557,238 L552,278 L542,318 L527,358 L507,388 L487,398 L467,388 L447,358 L432,318 L427,278 L430,238Z"/>
    <path d="M512,63 L562,58 L622,53 L682,58 L732,68 L782,78 L822,93 L842,113 L832,138 L802,153 L772,158 L742,168 L722,188 L702,198 L682,193 L612,178 L582,183 L557,173 L537,158 L507,123Z"/>
    <path d="M682,193 L722,198 L752,208 L762,233 L747,253 L722,258 L702,248 L690,228Z"/>
    <path d="M742,308 L802,303 L852,313 L877,333 L872,368 L847,393 L812,398 L777,388 L752,368 L737,343Z"/>
  </svg>
);

const KmCount=({target,animKey})=>{
  const [val,setVal]=useState(target);
  const prev=useRef(target);
  useEffect(()=>{if(target===prev.current)return;const from=prev.current,to=target,dur=700,t0=Date.now();const tick=()=>{const p=Math.min((Date.now()-t0)/dur,1);const e=1-Math.pow(1-p,3);setVal(Math.round(from+e*(to-from)));if(p<1)requestAnimationFrame(tick);else{setVal(to);prev.current=to;}};requestAnimationFrame(tick);},[animKey]);
  const fmt=n=>n>=1000?(n/1000).toFixed(1)+'K':String(n);
  return <span className="kmn">{fmt(val)} km</span>;
};

const TranslateBtn=({text})=>{
  const {t}=useT();
  const [state,setState]=useState('idle');
  const [result,setResult]=useState('');
  const go=async()=>{
    if(state==='done'){setState('idle');setResult('');return;}
    if(state==='loading')return;
    setState('loading');
    try{
      const lang=(navigator.language||'ko').split('-')[0];
      const url='https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl='+lang+'&dt=t&q='+encodeURIComponent(text);
      const res=await fetch(url);
      const d=await res.json();
      const tr=(d[0]||[]).map(x=>x&&x[0]||'').join('');
      if(tr&&tr.trim()&&tr!==text){setResult(tr);setState('done');}else setState('idle');
    }catch(e){setState('idle');}
  };
  if(state==='done')return(<div style={{marginTop:4}}><p style={{fontSize:11,color:'rgba(255,255,255,.75)',lineHeight:1.55,marginBottom:3,fontStyle:'italic'}}>{result}</p><button onClick={go} className="btn" style={{fontSize:9,color:'var(--dim)'}}>{t.translated} · {t.close}</button></div>);
  return(<button onClick={go} className="btn" style={{fontSize:9,color:'var(--p)',marginTop:3}}>{state==='loading'?'번역 중…':t.seeTranslation}</button>);
};

/* DATA */
const isVideoUrl=(url)=>{if(!url)return false;if(url.startsWith('blob:'))return true;const ext=url.split('?')[0].toLowerCase();return ext.endsWith('.mp4')||ext.endsWith('.mov')||ext.endsWith('.webm');};

const LOC={seoul:{name:'서울',mx:.762,my:.258},tokyo:{name:'Tokyo',mx:.797,my:.248},london:{name:'London',mx:.417,my:.152},nyc:{name:'New York',mx:.163,my:.218},sao:{name:'São Paulo',mx:.208,my:.558},sydney:{name:'Sydney',mx:.812,my:.668},paris:{name:'Paris',mx:.452,my:.172},nairobi:{name:'Nairobi',mx:.518,my:.458},la:{name:'LA',mx:.093,my:.252},mumbai:{name:'Mumbai',mx:.628,my:.348},cairo:{name:'Cairo',mx:.508,my:.318},mexico:{name:'Mexico City',mx:.118,my:.368},berlin:{name:'Berlin',mx:.468,my:.168},bkk:{name:'Bangkok',mx:.718,my:.368},dubai:{name:'Dubai',mx:.575,my:.31},jeju:{name:'Jeju',mx:.77,my:.28},rome:{name:'Rome',mx:.478,my:.218}};

const DEFAULT_USERS={'alex@kmilo.app':{id:'u1',pw:'kmilo123',name:'Alex Kim',handle:'@alexkim',bio:'Sound explorer. 47 countries.',avatar:'https://i.pravatar.cc/80?img=11',followers:48200,totalKm:124200},'jimin@kmilo.app':{id:'u2',pw:'kmilo123',name:'Jimin Lee',handle:'@jiminlee',bio:'Everyday moments. Parent & creator.',avatar:'https://i.pravatar.cc/80?img=5',followers:21000,totalKm:86300}};
let USERS=(()=>{try{const s=localStorage.getItem('kmilo_users');return s?{...DEFAULT_USERS,...JSON.parse(s)}:{...DEFAULT_USERS};}catch(e){return{...DEFAULT_USERS};}})();
const saveUsers=()=>{try{const extra={};Object.keys(USERS).forEach(k=>{if(!DEFAULT_USERS[k])extra[k]=USERS[k];});localStorage.setItem('kmilo_users',JSON.stringify(extra));}catch(e){}};

const NOW=Date.now();
const mke=(h)=>NOW-(h*3600000);
const INIT_BUBBLES=[
  {id:'b1',creatorHandle:'@alexkim',creator:{name:'Alex Kim',handle:'@alexkim',avatar:'https://i.pravatar.cc/80?img=11'},createdAt:mke(2),expiresAt:mke(2)+86400000,question:'서울에서 가장 좋아하는 숨겨진 장소는? ',askerName:'익명',askerCountry:'',answers:[{id:'a1',type:'private',to:'u2',text:'유키상, 비밀인데... 을지로 골목 오래된 카페들이에요! 아무도 잘 모르는 곳.',createdAt:mke(1.5)}],publicAnswer:{id:'pa1',type:'public',text:'을지로 골목이에요. 10년 전 카페들이 아직 그대로예요.',createdAt:mke(1)}},
  {id:'b2',creatorHandle:'@alexkim',creator:{name:'Alex Kim',handle:'@alexkim',avatar:'https://i.pravatar.cc/80?img=11'},createdAt:mke(5),expiresAt:mke(5)+86400000,question:'다음 릴레이 주제 힌트 주세요! ',askerName:'익명',askerCountry:'',answers:[],publicAnswer:null},
  {id:'b3',creatorHandle:'@jiminlee',creator:{name:'Jimin Lee',handle:'@jiminlee',avatar:'https://i.pravatar.cc/80?img=5'},createdAt:mke(8),expiresAt:mke(8)+86400000,question:'아이를 키우면서 창작 활동을 어떻게 유지하나요?',askerName:'익명',askerCountry:'',answers:[{id:'a2',type:'private',to:'u1',text:'소피님, 저도 처음엔 너무 힘들었어요. 아이가 자는 새벽 2시가 제 황금 시간이에요.',createdAt:mke(7)}],publicAnswer:{id:'pa2',type:'public',text:'새벽 2시가 제 황금 창작 시간이에요. 모두가 잠든 그 고요함.',createdAt:mke(6.5)}},
  {id:'b4',creatorHandle:'@jiminlee',creator:{name:'Jimin Lee',handle:'@jiminlee',avatar:'https://i.pravatar.cc/80?img=5'},createdAt:mke(14),expiresAt:mke(14)+86400000,question:'촬영할 때 가장 중요하게 생각하는 것은?',askerName:'익명',askerCountry:'',answers:[],publicAnswer:null},
];

const SEEDS=[
  {id:'s1',uid:'u1',name:'Alex Kim',handle:'@alexkim',avatar:'https://i.pravatar.cc/80?img=11',cat:'Weather',title:'Rain Resonance',thumb:'https://images.unsplash.com/photo-1515694346937-94d85e41e6f0?w=800',totalKm:42800,honors:3420,countries:47,type:'portrait',comments:[{id:'c1',user:'seoul_vibe',text:'이 빗소리가 마음을 울렸어요. 서울의 기억이 새록새록.',avatar:'https://i.pravatar.cc/40?img=20',time:'3h'},{id:'c2',user:'tokyo_ears',text:'Amazing how rain sounds the same yet feels different.',avatar:'https://i.pravatar.cc/40?img=21',time:'5h'}],participants:[{id:'p1',name:'Alex Kim',handle:'@alexkim',avatar:'https://i.pravatar.cc/80?img=11',city:'Seoul',loc:LOC.seoul,km:0,photo:'https://images.unsplash.com/photo-1515694346937-94d85e41e6f0?w=800',desc:'First summer rain on old Seoul rooftiles.'},{id:'p2',name:'Yuki T.',handle:'@yukisounds',avatar:'https://i.pravatar.cc/80?img=8',city:'Tokyo',loc:LOC.tokyo,km:1200,photo:'https://images.unsplash.com/photo-1542640244-7e672d6cef4e?w=800',desc:'Shibuya umbrella rain.'},{id:'p3',name:'Emma W.',handle:'@emmaldn',avatar:'https://i.pravatar.cc/80?img=9',city:'London',loc:LOC.london,km:9200,photo:'https://images.unsplash.com/photo-1516912481808-3406841bd33c?w=800',desc:'Thames riverside afternoon rain.'},{id:'p4',name:'Carlos M.',handle:'@carlosny',avatar:'https://i.pravatar.cc/80?img=15',city:'New York',loc:LOC.nyc,km:21000,photo:'https://images.unsplash.com/photo-1534430480872-3498386e7856?w=800',desc:'Brooklyn windows in summer storm.'},{id:'p5',name:'Luisa S.',handle:'@luisabr',avatar:'https://i.pravatar.cc/80?img=20',city:'São Paulo',loc:LOC.sao,km:18600,photo:'https://images.unsplash.com/photo-1477519242566-6ae87c31d212?w=800',desc:'Evening downpour in São Paulo.'}]},
  {id:'s2',uid:'u2',name:'Jimin Lee',handle:'@jiminlee',avatar:'https://i.pravatar.cc/80?img=5',cat:'Family',title:'Morning Table',thumb:'https://images.unsplash.com/photo-1596464716127-f2a82984de30?w=800',totalKm:28400,honors:1840,countries:31,type:'landscape',comments:[{id:'c1',user:'papa_paris',text:'Cette table du matin me rappelle mes enfants.',avatar:'https://i.pravatar.cc/40?img=30',time:'2h'}],participants:[{id:'p1',name:'Jimin Lee',handle:'@jiminlee',avatar:'https://i.pravatar.cc/80?img=5',city:'Seoul',loc:LOC.seoul,km:0,photo:'https://images.unsplash.com/photo-1596464716127-f2a82984de30?w=800',desc:'100-day breakfast. First sounds of a new life.'},{id:'p2',name:'Sophie B.',handle:'@sophieparis',avatar:'https://i.pravatar.cc/80?img=4',city:'Paris',loc:LOC.paris,km:9150,photo:'https://images.unsplash.com/photo-1504674900247-0877df9cc836?w=800',desc:'Paris apartment breakfast.'},{id:'p3',name:'Amara O.',handle:'@amaranairobi',avatar:'https://i.pravatar.cc/80?img=22',city:'Nairobi',loc:LOC.nairobi,km:12300,photo:'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?w=800',desc:'Nairobi family breakfast.'},{id:'p4',name:'Mei C.',handle:'@meitokyo',avatar:'https://i.pravatar.cc/80?img=28',city:'Tokyo',loc:LOC.tokyo,km:1100,photo:'https://images.unsplash.com/photo-1484659619207-9165d119dafe?w=800',desc:'Japanese morning ritual.'}]},
  {id:'s3',uid:'u1',name:'Alex Kim',handle:'@alexkim',avatar:'https://i.pravatar.cc/80?img=11',cat:'Food',title:'Secret Pasta',thumb:'https://images.unsplash.com/photo-1473093226795-af9932fe5856?w=800',totalKm:58200,honors:3100,countries:62,type:'portrait',comments:[{id:'c1',user:'nonna_roma',text:'Mia nonna farebbe la stessa cosa.',avatar:'https://i.pravatar.cc/40?img=33',time:'1h'},{id:'c2',user:'chef_bkk',text:'The dough sound is universal!',avatar:'https://i.pravatar.cc/40?img=34',time:'4h'}],participants:[{id:'p1',name:'Alex Kim',handle:'@alexkim',avatar:'https://i.pravatar.cc/80?img=11',city:'Paris',loc:LOC.paris,km:0,photo:'https://images.unsplash.com/photo-1473093226795-af9932fe5856?w=800',desc:"Nonna's Neapolitan pasta dough."},{id:'p2',name:'Marco R.',handle:'@marcorome',avatar:'https://i.pravatar.cc/80?img=14',city:'Rome',loc:LOC.rome,km:1400,photo:'https://images.unsplash.com/photo-1621996346565-e3dbc646d9a9?w=800',desc:"Rome family kitchen."},{id:'p3',name:'Kenji H.',handle:'@kenjitokyo',avatar:'https://i.pravatar.cc/80?img=18',city:'Tokyo',loc:LOC.tokyo,km:9800,photo:'https://images.unsplash.com/photo-1569050467447-ce54b3bbc37d?w=800',desc:'Wafū pasta born in Tokyo.'},{id:'p4',name:'Yuna L.',handle:'@yunala',avatar:'https://i.pravatar.cc/80?img=28',city:'LA',loc:LOC.la,km:13200,photo:'https://images.unsplash.com/photo-1563379091339-03b21ab4a4f8?w=800',desc:'Koreatown LA fusion pasta.'}]},
  {id:'s4',uid:'u2',name:'Jimin Lee',handle:'@jiminlee',avatar:'https://i.pravatar.cc/80?img=5',cat:'Nature',title:'Dawn Forest',thumb:'https://images.unsplash.com/photo-1448375240586-882707db888b?w=800',totalKm:19600,honors:2780,countries:38,type:'landscape',comments:[{id:'c1',user:'forest_berlin',text:'Diese Stille ist wunderschön.',avatar:'https://i.pravatar.cc/40?img=41',time:'30m'}],participants:[{id:'p1',name:'Jimin Lee',handle:'@jiminlee',avatar:'https://i.pravatar.cc/80?img=5',city:'Jeju',loc:LOC.jeju,km:0,photo:'https://images.unsplash.com/photo-1448375240586-882707db888b?w=800',desc:'Jeju bamboo forest at 4am.'},{id:'p2',name:'Tariq N.',handle:'@tariqnairobi',avatar:'https://i.pravatar.cc/80?img=30',city:'Nairobi',loc:LOC.nairobi,km:10200,photo:'https://images.unsplash.com/photo-1535941339077-2dd1c7963098?w=800',desc:'Nairobi National Park dawn.'},{id:'p3',name:'Lena M.',handle:'@lenaberlin',avatar:'https://i.pravatar.cc/80?img=35',city:'Berlin',loc:LOC.berlin,km:9400,photo:'https://images.unsplash.com/photo-1448375240586-882707db888b?w=800',desc:'Tiergarten park before sunrise.'}]},
  {id:'s5',uid:'u1',name:'Alex Kim',handle:'@alexkim',avatar:'https://i.pravatar.cc/80?img=11',cat:'City',title:'Midnight City',thumb:'https://images.unsplash.com/photo-1540959733332-eab4deabeeaf?w=800',totalKm:35400,honors:4100,countries:52,type:'portrait',comments:[{id:'c1',user:'night_owl_ny',text:'Midnight cities around the world — poetry.',avatar:'https://i.pravatar.cc/40?img=43',time:'45m'}],participants:[{id:'p1',name:'Alex Kim',handle:'@alexkim',avatar:'https://i.pravatar.cc/80?img=11',city:'Tokyo',loc:LOC.tokyo,km:0,photo:'https://images.unsplash.com/photo-1540959733332-eab4deabeeaf?w=800',desc:'Shibuya Scramble at 2am.'},{id:'p2',name:'Fatima A.',handle:'@fatimacairo',avatar:'https://i.pravatar.cc/80?img=37',city:'Cairo',loc:LOC.cairo,km:9100,photo:'https://images.unsplash.com/photo-1539768942893-daf6b8e1debb?w=800',desc:'Cairo never sleeps.'},{id:'p3',name:'Diego V.',handle:'@diegomx',avatar:'https://i.pravatar.cc/80?img=38',city:'Mexico City',loc:LOC.mexico,km:12800,photo:'https://images.unsplash.com/photo-1518105779142-d975f22f1b0a?w=800',desc:'Reforma Avenue at midnight.'},{id:'p4',name:'Nora K.',handle:'@norabkk',avatar:'https://i.pravatar.cc/80?img=39',city:'Bangkok',loc:LOC.bkk,km:5200,photo:'https://images.unsplash.com/photo-1508009603885-50cf7c579365?w=800',desc:'Bangkok street markets at 1am.'}]},
  {id:'s6',uid:'u2',name:'Jimin Lee',handle:'@jiminlee',avatar:'https://i.pravatar.cc/80?img=5',cat:'Ocean',title:'Deep Blue',thumb:'https://images.unsplash.com/photo-1505118380757-91f5f5632de0?w=800',totalKm:31200,honors:2660,countries:44,type:'landscape',comments:[{id:'c1',user:'surfer_sydney',text:'The ocean never sounds the same twice.',avatar:'https://i.pravatar.cc/40?img=51',time:'1h'}],participants:[{id:'p1',name:'Jimin Lee',handle:'@jiminlee',avatar:'https://i.pravatar.cc/80?img=5',city:'Jeju',loc:LOC.jeju,km:0,photo:'https://images.unsplash.com/photo-1505118380757-91f5f5632de0?w=800',desc:'Jeju haenyeo diving.'},{id:'p2',name:'Kai S.',handle:'@kaisurf',avatar:'https://i.pravatar.cc/80?img=47',city:'Sydney',loc:LOC.sydney,km:7800,photo:'https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=800',desc:'Bondi Beach at dawn.'},{id:'p3',name:'Marina C.',handle:'@marinabali',avatar:'https://i.pravatar.cc/80?img=48',city:'Bali',loc:{name:'Bali',mx:.728,my:.418},km:5200,photo:'https://images.unsplash.com/photo-1537996194471-e657df975ab4?w=800',desc:'Uluwatu cliffs.'}]},
  {id:'s7',uid:'u1',name:'Alex Kim',handle:'@alexkim',avatar:'https://i.pravatar.cc/80?img=11',cat:'Light',title:'Golden Hour',thumb:'https://images.unsplash.com/photo-1495616811223-4d98c6e9c869?w=800',totalKm:18900,honors:1620,countries:25,type:'portrait',comments:[{id:'c1',user:'light_seoul',text:'빛은 언어를 초월합니다.',avatar:'https://i.pravatar.cc/40?img=54',time:'5h'}],participants:[{id:'p1',name:'Alex Kim',handle:'@alexkim',avatar:'https://i.pravatar.cc/80?img=11',city:'Seoul',loc:LOC.seoul,km:0,photo:'https://images.unsplash.com/photo-1495616811223-4d98c6e9c869?w=800',desc:'Namsan Tower golden hour.'},{id:'p2',name:'Isabelle D.',handle:'@isabelleparis',avatar:'https://i.pravatar.cc/80?img=46',city:'Paris',loc:LOC.paris,km:9150,photo:'https://images.unsplash.com/photo-1491555103944-7c647fd857e6?w=800',desc:'Eiffel Tower at golden hour.'},{id:'p3',name:'Amir H.',handle:'@amirdubai',avatar:'https://i.pravatar.cc/80?img=47',city:'Dubai',loc:LOC.dubai,km:6800,photo:'https://images.unsplash.com/photo-1512453979798-5ea266f8880c?w=800',desc:'Desert sunset in Dubai.'}]},
  {id:'s8',uid:'u2',name:'Jimin Lee',handle:'@jiminlee',avatar:'https://i.pravatar.cc/80?img=5',cat:'Music',title:'Street Melody',thumb:'https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?w=800',totalKm:22100,honors:2200,countries:28,type:'landscape',comments:[{id:'c1',user:'busker_london',text:'10 years busking in London. This is everything.',avatar:'https://i.pravatar.cc/40?img=46',time:'7h'}],participants:[{id:'p1',name:'Jimin Lee',handle:'@jiminlee',avatar:'https://i.pravatar.cc/80?img=5',city:'Seoul',loc:LOC.seoul,km:0,photo:'https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?w=800',desc:'Hongdae street musician at dusk.'},{id:'p2',name:'Sam W.',handle:'@samnyc',avatar:'https://i.pravatar.cc/80?img=44',city:'New York',loc:LOC.nyc,km:9800,photo:'https://images.unsplash.com/photo-1514320291840-2e0a9bf2a9ae?w=800',desc:'NYC subway jazz.'},{id:'p3',name:'Aiko T.',handle:'@aikotokyo',avatar:'https://i.pravatar.cc/80?img=45',city:'Tokyo',loc:LOC.tokyo,km:1200,photo:'https://images.unsplash.com/photo-1516280440614-37939bbacd81?w=800',desc:'Shinjuku station performer.'}]},
  {id:'s9',uid:'u1',name:'Alex Kim',handle:'@alexkim',avatar:'https://i.pravatar.cc/80?img=11',cat:'Market',title:'Street Market',thumb:'https://images.unsplash.com/photo-1555396273-367ea4eb4db5?w=800',totalKm:24500,honors:1980,countries:33,type:'portrait',comments:[{id:'c1',user:'bazaar_istanbul',text:"The Grand Bazaar — my grandmother's spirit.",avatar:'https://i.pravatar.cc/40?img=55',time:'3h'}],participants:[{id:'p1',name:'Alex Kim',handle:'@alexkim',avatar:'https://i.pravatar.cc/80?img=11',city:'Bangkok',loc:LOC.bkk,km:0,photo:'https://images.unsplash.com/photo-1555396273-367ea4eb4db5?w=800',desc:'Chatuchak market. 15,000 stalls.'},{id:'p2',name:'Ayse K.',handle:'@ayseistanbul',avatar:'https://i.pravatar.cc/80?img=49',city:'Istanbul',loc:{name:'Istanbul',mx:.525,my:.225},km:5300,photo:'https://images.unsplash.com/photo-1524231757912-21f4fe3a7200?w=800',desc:'Grand Bazaar. 4000 years.'},{id:'p3',name:'Luis P.',handle:'@luismex',avatar:'https://i.pravatar.cc/80?img=50',city:'Mexico City',loc:LOC.mexico,km:15800,photo:'https://images.unsplash.com/photo-1515443961218-a51367888e4b?w=800',desc:'Mercado de Jamaica.'}]},
];

const NOTIFS=[{id:'n1',read:false,text:'Seoul_Vibe가 릴레이에 참여했습니다',sub:'Rain Resonance',time:'2m'},{id:'n2',read:false,text:'버블 질문이 도착했습니다',sub:'도쿄 팬 유키',time:'5m'},{id:'n3',read:true,text:'Global Sounds started following you',sub:null,time:'1h'},{id:'n4',read:true,text:'Relay hit 10,000km!',sub:'Rain Resonance',time:'1d'}];

const fmtLeft=(exp)=>{const ms=exp-Date.now();if(ms<=0)return null;const h=Math.floor(ms/3600000);const m=Math.floor((ms%3600000)/60000);return h>0?`${h}h ${m}m`:`${m}m`;};

/* ═══ BUBBLE COMPONENTS ═══ */

/* ── 스토리형 버블 카드 뷰어 ── */
/* ── 받은 질문함 + 답변 모달 (크리에이터용) ── */
const FollowListModal=({title,list,onClose})=>{
  return(
    <div style={{position:'absolute',inset:0,zIndex:92,background:'rgba(8,0,15,.98)',display:'flex',flexDirection:'column'}} className="af">
      <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'16px 18px',borderBottom:'1px solid rgba(168,85,247,.12)',flexShrink:0}}>
        <div style={{fontSize:13,fontWeight:700}}>{title}</div>
        <button onClick={onClose} className="btn" style={{fontSize:24,color:'var(--dim)'}}>×</button>
      </div>
      <div className="sc" style={{flex:1,padding:'14px 18px 24px',display:'flex',flexDirection:'column',gap:10}}>
        {list.length===0&&<div style={{textAlign:'center',padding:'40px 0',fontSize:11,color:'var(--dim)'}}>아직 없어요</div>}
        {list.map((u,i)=>(
          <div key={i} style={{display:'flex',alignItems:'center',gap:12,padding:'8px 0'}}>
            <img src={u.avatar||`https://i.pravatar.cc/80?img=${i+1}`} style={{width:38,height:38,borderRadius:99,objectFit:'cover',border:'1.5px solid rgba(168,85,247,.3)'}} alt=""/>
            <div>
              <div style={{fontSize:13,fontWeight:600}}>{u.name}</div>
              <div style={{fontSize:10,color:'var(--dim)'}}>{u.handle}</div>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
};

const InboxModal=({bubbles,user,onClose,onReply})=>{
  const {t}=useT();
  /* 아직 답변 안 된 질문만 표시 */
  const unanswered=bubbles.filter(b=>!b.publicAnswer&&!b.answers.some(a=>a.to===user.id)&&fmtLeft(b.expiresAt));
  const answered=bubbles.filter(b=>(b.publicAnswer||b.answers.some(a=>a.to===user.id))&&fmtLeft(b.expiresAt));
  return(
    <div style={{position:'absolute',inset:0,zIndex:92,background:'rgba(8,0,15,.98)',display:'flex',flexDirection:'column'}} className="af">
      <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'16px 18px',borderBottom:'1px solid rgba(168,85,247,.12)',flexShrink:0}}>
        <div>
          <div style={{fontSize:13,fontWeight:700}}>{t.inbox}</div>
          {unanswered.length>0&&<div style={{fontSize:9,color:'var(--pk)',marginTop:1}}>{t.unanswered} {unanswered.length}</div>}
        </div>
        <button onClick={onClose} className="btn" style={{fontSize:24,color:'var(--dim)'}}>×</button>
      </div>
      <div className="sc" style={{flex:1,padding:'14px 18px 24px',display:'flex',flexDirection:'column',gap:8}}>
        {unanswered.length===0&&answered.length===0&&(
          <div style={{textAlign:'center',padding:'40px 0',fontSize:11,color:'var(--dim)'}}>{t.noQuestions}</div>
        )}
        {unanswered.map(b=>(
          <div key={b.id} style={{borderRadius:14,background:'rgba(168,85,247,.09)',border:'1px solid rgba(168,85,247,.22)',padding:'14px 16px'}}>
            <div style={{fontSize:9,color:'var(--p)',marginBottom:6,fontWeight:600}}>{t.unanswered} · {fmtLeft(b.expiresAt)} {t.unansweredLeft}</div>
            <p style={{fontSize:13,color:'rgba(255,255,255,.88)',lineHeight:1.55,marginBottom:12}}>{b.question}</p>
            <div style={{display:'flex',gap:8}}>
              <button onClick={()=>onReply(b,'private')} className="btn"
                style={{flex:1,padding:'9px',borderRadius:10,border:'1px solid rgba(168,85,247,.3)',background:'rgba(168,85,247,.08)',flexDirection:'column',gap:2}}>
                <div style={{fontSize:10,fontWeight:700,color:'var(--p)'}}>{t.privateReply}</div>
                <div style={{fontSize:8,color:'var(--dim)'}}>{t.toAskerOnly}</div>
              </button>
              <button onClick={()=>onReply(b,'public')} className="btn"
                style={{flex:1,padding:'9px',borderRadius:10,border:'1px solid rgba(236,72,153,.3)',background:'rgba(236,72,153,.08)',flexDirection:'column',gap:2}}>
                <div style={{fontSize:10,fontWeight:700,color:'var(--pk)'}}>{t.publicReply}</div>
                <div style={{fontSize:8,color:'var(--dim)'}}>{t.postOnCard}</div>
              </button>
            </div>
          </div>
        ))}
        {answered.length>0&&<>
          <div style={{fontSize:9,color:'var(--dim)',letterSpacing:'.07em',marginTop:8,marginBottom:4}}>{t.answeredDone}</div>
          {answered.map(b=>(
            <div key={b.id} style={{borderRadius:14,background:'rgba(255,255,255,.03)',border:'1px solid rgba(255,255,255,.07)',padding:'14px 16px'}}>
              <div style={{fontSize:8,color:'rgba(168,85,247,.5)',fontWeight:700,marginBottom:4,letterSpacing:'.08em'}}>Q</div>
              <p style={{fontSize:12,color:'rgba(255,255,255,.65)',lineHeight:1.5,marginBottom:8}}>{b.question}</p>
              <div style={{height:1,background:'rgba(168,85,247,.12)',marginBottom:8}}/>
              <div style={{fontSize:8,fontWeight:700,marginBottom:6,color:b.publicAnswer?'var(--pk)':'var(--p)'}}>{b.publicAnswer?t.publicAnswerDone:t.privateAnswerDone}</div>
              {b.publicAnswer&&<p style={{fontSize:12,color:'rgba(255,255,255,.88)',lineHeight:1.55}}>{b.publicAnswer.text}</p>}
              {!b.publicAnswer&&b.answers&&b.answers.length>0&&<p style={{fontSize:12,color:'rgba(255,255,255,.88)',lineHeight:1.55}}>{b.answers[0].text}</p>}
            </div>
          ))}
        </>}
      </div>
    </div>
  );
};

/* ── 답변 작성 모달 ── */
const ReplyModal=({bubble,replyType,onClose,onSend})=>{
  const {t}=useT();
  const [text,setText]=useState('');
  const isPub=replyType==='public';
  const send=()=>{if(!text.trim())return;onSend(bubble.id,replyType,text);};
  return(
    <div style={{position:'absolute',inset:0,zIndex:95,background:'rgba(8,0,15,.98)',display:'flex',flexDirection:'column'}} className="af">
      <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'16px 18px',borderBottom:'1px solid rgba(168,85,247,.12)',flexShrink:0}}>
        <div style={{fontSize:13,fontWeight:700,color:isPub?'var(--pk)':'var(--p)'}}>{isPub?t.publicAnswer:t.privateAnswer}</div>
        <button onClick={onClose} className="btn" style={{fontSize:24,color:'var(--dim)'}}>×</button>
      </div>
      <div className="sc" style={{flex:1,padding:'18px',display:'flex',flexDirection:'column',gap:14}}>
        <div style={{padding:'14px 16px',borderRadius:14,background:'linear-gradient(145deg,rgba(124,58,237,.15),rgba(236,72,153,.08))',border:'1px solid rgba(168,85,247,.2)'}}>
          <div style={{fontSize:8,color:'rgba(168,85,247,.5)',letterSpacing:'.1em',marginBottom:6,fontWeight:700}}>QUESTION</div>
          <p style={{fontSize:13,color:'rgba(255,255,255,.82)',lineHeight:1.55}}>{bubble.question}</p>
        </div>
        {isPub&&<div style={{fontSize:9,color:'var(--pk)',lineHeight:1.5}}>{t.publicAnswerHint}</div>}
        {!isPub&&<div style={{fontSize:9,color:'var(--dim)'}}>{t.privateAnswerHint}</div>}
        <textarea className="inp" value={text} onChange={e=>setText(e.target.value)}
          placeholder={isPub?t.publicAnswerPlaceholder:t.privateAnswerPlaceholder} style={{height:110}}/>
        <div style={{display:'flex',gap:10}}>
          <button onClick={onClose} className="btn" style={{flex:1,padding:'12px',borderRadius:12,border:'1px solid rgba(255,255,255,.1)',fontSize:12,color:'var(--dim)'}}>{t.cancel}</button>
          <button onClick={send} disabled={!text.trim()} className="gbtn" style={{flex:2,padding:'12px',borderRadius:12,fontSize:12,opacity:text.trim()?1:.4}}>
            {isPub?t.publicPost:t.privateSend}
          </button>
        </div>
      </div>
    </div>
  );
};

/* ── 질문 보내기 모달 ── */

/* ═══ SHARE SHEET ═══ */
const ShareSheet=({seed,onClose})=>{
  const url=location.href;
  const title=seed.title+' · Kmilo';
  const toast=(msg)=>{
    try{navigator.clipboard.writeText(url);}catch(e){}
    const el=document.createElement('div');
    el.style.cssText='position:fixed;bottom:90px;left:50%;transform:translateX(-50%);background:#111;color:#fff;padding:8px 20px;border-radius:99px;font-size:12px;z-index:99999;white-space:nowrap;pointer-events:none;box-shadow:0 4px 20px rgba(0,0,0,.4)';
    el.textContent=msg;document.body.appendChild(el);
    setTimeout(()=>el.parentNode&&el.parentNode.removeChild(el),2200);
  };
  const svgs={
    kakao:'<svg viewBox="0 0 44 44"><rect width="44" height="44" rx="12" fill="#FEE500"/><path d="M22 10c-6.627 0-12 4.03-12 9 0 3.206 2.138 6.016 5.362 7.624l-1.366 4.964c-.12.443.384.806.768.562L21.3 29.4c.23.023.464.04.7.04 6.627 0 12-4.03 12-9s-5.373-9-12-9z" fill="#3C1E1E"/></svg>',
    insta:'<svg viewBox="0 0 44 44"><defs><linearGradient id="ig1" x1="0" y1="1" x2="1" y2="0"><stop offset="0%" stop-color="#f09433"/><stop offset="35%" stop-color="#e6683c"/><stop offset="60%" stop-color="#dc2743"/><stop offset="80%" stop-color="#cc2366"/><stop offset="100%" stop-color="#833ab4"/></linearGradient></defs><rect width="44" height="44" rx="12" fill="url(#ig1)"/><rect x="11" y="11" width="22" height="22" rx="6" fill="none" stroke="white" stroke-width="2.2"/><circle cx="22" cy="22" r="5.5" fill="none" stroke="white" stroke-width="2.2"/><circle cx="28.7" cy="15.3" r="1.5" fill="white"/></svg>',
    x:'<svg viewBox="0 0 44 44"><rect width="44" height="44" rx="12" fill="#000"/><path d="M25.3 20.2L32.3 12h-1.7l-6.2 7.2-4.9-7.2H13l7.4 10.8L13 32h1.7l6.5-7.5 5.2 7.5H33z" fill="#fff"/></svg>',
    fb:'<svg viewBox="0 0 44 44"><rect width="44" height="44" rx="12" fill="#0866FF"/><path d="M25.5 15.5h-2.5c-.66 0-1.5.84-1.5 1.5V19h4l-.6 4H21.5v10h-4V23H15v-4h2.5v-2.5C17.5 13.12 19.62 11 22.5 11H25.5v4.5z" fill="white"/></svg>',
    wa:'<svg viewBox="0 0 44 44"><rect width="44" height="44" rx="12" fill="#25D366"/><path d="M22 9C14.82 9 9 14.82 9 22c0 2.27.61 4.4 1.68 6.24L9 35l6.96-1.63A13 13 0 0022 35c7.18 0 13-5.82 13-13S29.18 9 22 9zm6.08 17.36c-.27.73-1.56 1.4-2.13 1.48-.55.08-1.21.11-1.95-.12-.45-.14-.99-.33-1.75-.65-3.07-1.32-5.08-4.43-5.23-4.63-.16-.2-1.22-1.63-1.22-3.1s.77-2.2 1.04-2.5c.27-.3.59-.37.79-.37h.56c.18 0 .44-.07.69.53l.9 2.3c.07.18.12.4.01.64l-.34.6-.52.6c-.17.2-.34.41-.15.81.2.4.9 1.49 1.94 2.41 1.1.95 2.03 1.26 2.41 1.4.37.13.58.1.8-.07.2-.18.9-1.07 1.14-1.44.24-.37.49-.31.83-.18l2.4 1.13c.37.17.61.26.7.41.09.15.09.86-.17 1.59z" fill="white"/></svg>',
    link:'<svg viewBox="0 0 44 44"><rect width="44" height="44" rx="12" fill="#e8e8e8"/><path d="M20 25a5 5 0 0 0 7.07 0l3.5-3.5a5 5 0 0 0-7.07-7.07l-2 2" stroke="#444" stroke-width="2.2" fill="none" stroke-linecap="round"/><path d="M24 19a5 5 0 0 0-7.07 0L13 22.5a5 5 0 0 0 7.07 7.07l2-2" stroke="#444" stroke-width="2.2" fill="none" stroke-linecap="round"/></svg>',
    more:'<svg viewBox="0 0 44 44"><rect width="44" height="44" rx="12" fill="#e8e8e8"/><circle cx="14" cy="22" r="2.5" fill="#444"/><circle cx="22" cy="22" r="2.5" fill="#444"/><circle cx="30" cy="22" r="2.5" fill="#444"/></svg>',
  };
  const items=[
    {key:'kakao',label:'카카오톡',fn:()=>{toast('링크 복사됨');setTimeout(()=>{window.location.href='kakaolink://send';},400);}},
    {key:'insta',label:'인스타그램',fn:()=>{try{navigator.clipboard.writeText(title+' '+url);}catch(e){}window.open('https://www.instagram.com/','_blank');}},
    {key:'x',label:'X',fn:()=>{window.open('https://twitter.com/intent/tweet?text='+encodeURIComponent(title)+'&url='+encodeURIComponent(url),'_blank');}},
    {key:'fb',label:'Facebook',fn:()=>{window.open('https://www.facebook.com/sharer/sharer.php?u='+encodeURIComponent(url),'_blank');}},
    {key:'wa',label:'WhatsApp',fn:()=>{window.open('https://wa.me/?text='+encodeURIComponent(title+' '+url),'_blank');}},
    {key:'link',label:'링크 복사',fn:()=>{toast('링크가 복사됐어요 ✓');}},
    {key:'more',label:'더 보기',fn:()=>{if(navigator.share)navigator.share({title:seed.title,text:title,url}).catch(()=>{});else toast('링크가 복사됐어요 ✓');}},
  ];
  return(
    <div onClick={onClose} style={{position:'fixed',inset:0,zIndex:9000,display:'flex',alignItems:'flex-end'}}>
      <div style={{position:'absolute',inset:0,background:'rgba(0,0,0,.5)',backdropFilter:'blur(6px)'}}/>
      <div onClick={e=>e.stopPropagation()} style={{position:'relative',background:'#fff',borderRadius:'20px 20px 0 0',width:'100%',maxWidth:480,margin:'0 auto',paddingBottom:'max(env(safe-area-inset-bottom),16px)'}}>
        <div style={{display:'flex',justifyContent:'center',padding:'12px 0 4px'}}>
          <div style={{width:40,height:4,borderRadius:99,background:'#ddd'}}/>
        </div>
        <div style={{display:'flex',alignItems:'center',gap:10,margin:'10px 16px 16px',padding:'11px 14px',background:'#f5f5f5',borderRadius:14}}>
          <div style={{flex:1,overflow:'hidden'}}>
            <div style={{fontSize:12,fontWeight:700,color:'#111',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{seed.title}</div>
            <div style={{fontSize:10,color:'#aaa',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{url}</div>
          </div>
          <button onClick={()=>toast('링크가 복사됐어요 ✓')} style={{flexShrink:0,padding:'5px 14px',borderRadius:99,background:'#e0e0e0',border:'none',fontSize:11,fontWeight:700,color:'#333',cursor:'pointer',fontFamily:'inherit'}}>복사</button>
        </div>
        <div style={{display:'flex',overflowX:'auto',padding:'0 10px 56px',scrollbarWidth:'none',WebkitOverflowScrolling:'touch'}}>
          {items.map(({key,label,fn})=>(
            <button key={key} onClick={()=>{fn();onClose();}}
              style={{display:'flex',flexDirection:'column',alignItems:'center',gap:7,minWidth:70,padding:'4px 2px',background:'none',border:'none',cursor:'pointer',fontFamily:'inherit',flexShrink:0}}>
              <span dangerouslySetInnerHTML={{__html:svgs[key]}} style={{display:'block',lineHeight:0,width:44,height:44}}/>
              <span style={{fontSize:10,color:'#333'}}>{label}</span>
            </button>
          ))}
        </div>
      </div>
    </div>
  );
};

const AskModal=({creator,onClose,onSend})=>{
  const {t}=useT();
  const [text,setText]=useState('');
  const send=()=>{if(!text.trim())return;onSend(text.trim());};
  return(
    <div style={{position:'absolute',inset:0,zIndex:92,background:'rgba(8,0,15,.98)',display:'flex',flexDirection:'column'}} className="af">
      <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'16px 18px',borderBottom:'1px solid rgba(168,85,247,.12)',flexShrink:0}}>
        <div>
          <div style={{fontSize:13,fontWeight:700}}>{creator.name}{t.askTitle}</div>

        </div>
        <button onClick={onClose} className="btn" style={{fontSize:24,color:'var(--dim)'}}>×</button>
      </div>
      <div style={{flex:1,padding:'20px 18px',display:'flex',flexDirection:'column',gap:14}}>
        <textarea className="inp" value={text} onChange={e=>setText(e.target.value)}
          placeholder={t.askPlaceholder} style={{height:140}}/>
        <button onClick={send} disabled={!text.trim()} className="gbtn" style={{padding:'14px',borderRadius:12,fontSize:13,opacity:text.trim()?1:.4}}>
          {t.askSend}
        </button>
      </div>
    </div>
  );
};

/* ── 버블 섹션: 직사각형 카드 스와이퍼 ── */
const BubbleSection=({bubbles,user,onAsk,onOpenInbox,onReply,isOwn:isOwnProp})=>{
  const {t}=useT();
  /* 공개 답변된 것만 카드로 노출 */
  const cards=bubbles.filter(b=>b.publicAnswer&&fmtLeft(b.expiresAt));
  const unansweredCount=bubbles.filter(b=>!b.publicAnswer&&!b.answers.some(a=>a.to===user.id)&&fmtLeft(b.expiresAt)).length;
  const touchRef=useRef(null);
  const scrollRef=useRef(null);

  const onTs=e=>{touchRef.current=e.touches[0].clientX;};
  const onTe=e=>{
    if(!touchRef.current||!scrollRef.current)return;
    const dx=touchRef.current-e.changedTouches[0].clientX;
    scrollRef.current.scrollBy({left:dx*1.2,behavior:'smooth'});
    touchRef.current=null;
  };

  const isOwn=isOwnProp!==undefined?isOwnProp:(user&&bubbles.length>0&&bubbles[0].creatorHandle===user.handle);

  return(
    <div style={{padding:'16px 18px 0'}}>
      {/* 헤더 */}
      <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:12}}>
        <div style={{display:'flex',alignItems:'center',gap:7}}>
          <div style={{fontSize:13,fontWeight:700}}>{t.bubbleLabel}</div>
        </div>
        <div style={{display:'flex',gap:8,alignItems:'center'}}>
          {/* 크리에이터: 받은 질문함 */}
          {isOwn&&unansweredCount>0&&(
            <button onClick={onOpenInbox} className="btn"
              style={{fontSize:9,color:'var(--pk)',padding:'4px 10px',borderRadius:99,border:'1px solid rgba(236,72,153,.3)',position:'relative'}}>
              {t.inbox} {unansweredCount}
            </button>
          )}
          {isOwn&&unansweredCount===0&&(
            <button onClick={onOpenInbox} className="btn"
              style={{fontSize:9,color:'var(--dim)',padding:'4px 10px',borderRadius:99,border:'1px solid rgba(255,255,255,.1)'}}>
              {t.inbox}
            </button>
          )}
          {/* 버블 보내기 버튼 (버블) */}
          <button onClick={onAsk} className="btn"
            style={{fontSize:9,color:'var(--p)',padding:'4px 10px',borderRadius:99,border:'1px solid rgba(168,85,247,.3)',fontWeight:700}}>
            {t.bubbleLabel}
          </button>
        </div>
      </div>

      {/* 직사각형 카드 스와이퍼 */}
      {cards.length===0?(
        <div style={{borderRadius:14,background:'rgba(255,255,255,.03)',border:'1px solid rgba(255,255,255,.06)',padding:'22px 16px',textAlign:'center'}}>
          <div style={{fontSize:11,color:'var(--dim)',lineHeight:1.7}}>
            {isOwn?t.ownBubbleHint:t.noPublicBubble}
          </div>
        </div>
      ):(
        <div ref={scrollRef} onTouchStart={onTs} onTouchEnd={onTe}
          style={{display:'flex',gap:10,overflowX:'auto',paddingBottom:4,scrollSnapType:'x mandatory'}}>
          {cards.map((b,i)=>{
            const tl=fmtLeft(b.expiresAt);
            const prog=Math.max(0,(b.expiresAt-Date.now())/86400000*100);
            return(
              <div key={b.id} style={{
                minWidth:220,maxWidth:240,borderRadius:16,flexShrink:0,scrollSnapAlign:'start',
                background:'linear-gradient(145deg,rgba(20,8,35,1),rgba(15,5,28,1))',
                border:'1px solid rgba(168,85,247,.2)',
                overflow:'hidden',cursor:'pointer',
              }}>
                {/* 타이머바 */}
                <div style={{height:2,background:'rgba(255,255,255,.06)'}}>
                  <div style={{height:'100%',width:`${prog}%`,background:'linear-gradient(90deg,#7c3aed,#ec4899)'}}/>
                </div>
                <div style={{padding:'14px 14px 16px'}}>
                  {/* 질문 (작게) */}
                  <div style={{fontSize:9,color:'rgba(168,85,247,.55)',letterSpacing:'.1em',fontWeight:700,marginBottom:5}}>Q</div>
                  <p style={{fontSize:11,color:'rgba(255,255,255,.55)',lineHeight:1.5,marginBottom:12,
                    display:'-webkit-box',WebkitLineClamp:2,WebkitBoxOrient:'vertical',overflow:'hidden'}}>
                    {b.question}
                  </p>
                  {/* 구분선 */}
                  <div style={{height:1,background:'rgba(168,85,247,.12)',marginBottom:12}}/>
                  {/* 답변 (보통) */}
                  <div style={{display:'flex',alignItems:'center',gap:6,marginBottom:8}}>
                    <img src={b.creator.avatar} style={{width:16,height:16,borderRadius:99,objectFit:'cover'}} alt=""/>
                    <div style={{fontSize:10,fontWeight:700,color:'rgba(255,255,255,.7)'}}>{b.creator.name}</div>
                    <div style={{marginLeft:'auto',fontSize:8,padding:'1px 6px',borderRadius:99,background:'rgba(236,72,153,.18)',color:'var(--pk)'}}>{t.publicBadge}</div>
                  </div>
                  <p style={{fontSize:13,color:'rgba(255,255,255,.92)',lineHeight:1.6,fontWeight:500,wordBreak:'break-word'}}>
                    {b.publicAnswer.text}
                  </p>
                  <div style={{fontSize:8,color:'var(--dim)',marginTop:8}}>{tl} {t.timeLeft}</div>
                </div>
              </div>
            );
          })}
        </div>
      )}
    </div>
  );
};

/* ═══ FULLSCREEN VIEWER ═══ */
/* ── 유저 프로필 모달 ── */
const UserProfile=({targetUser,currentUser,seeds,onClose,onAsk,onOpen})=>{
  const {t}=useT();
  const isMe=currentUser&&targetUser.handle===currentUser.handle;
  /* USERS에서 풀 프로필 찾기, 없으면 participant 데이터 사용 */
  const fullUser=Object.values(USERS).find(u=>u.handle===targetUser.handle)||targetUser;
  /* 해당 유저가 참여한 릴레이 */
  const userSeeds=(seeds||[]).filter(s=>s.participants.some(p=>p.handle===targetUser.handle));
  const totalKm=userSeeds.reduce((a,s)=>{
    const part=s.participants.find(p=>p.handle===targetUser.handle);
    return a+(part?.km||0);
  },0);
  const followers=fullUser.followers||0;
  return(
    <div style={{position:'absolute',inset:0,zIndex:96,background:'rgba(8,0,15,.82)'}} onClick={e=>{if(e.target===e.currentTarget)onClose();}}>
      <div style={{position:'absolute',bottom:0,left:0,right:0,background:'#0d0018',borderRadius:'18px 18px 0 0',maxHeight:'88vh',display:'flex',flexDirection:'column',paddingBottom:'env(safe-area-inset-bottom)'}} className="asu" onClick={e=>e.stopPropagation()}>
        {/* 헤더 그라디언트 배경 */}
        <div style={{padding:'22px 20px 16px',background:'linear-gradient(180deg,rgba(124,58,237,.12)0%,transparent 100%)',flexShrink:0}}>
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:16}}>
            <div style={{fontSize:10,color:'var(--p)',letterSpacing:'.08em'}}>PROFILE</div>
            <button onClick={onClose} className="btn" style={{fontSize:24,color:'var(--dim)'}}>×</button>
          </div>
          {/* 아바타 + 이름 */}
          <div style={{display:'flex',gap:14,alignItems:'center',marginBottom:12}}>
            <div style={{position:'relative',width:58,height:58,borderRadius:99,flexShrink:0}}>
              <div style={{position:'absolute',inset:-2,borderRadius:99,background:'linear-gradient(135deg,#7c3aed,#ec4899)'}}/>
              <img src={targetUser.avatar} style={{position:'relative',width:58,height:58,borderRadius:99,objectFit:'cover',border:'2.5px solid #08000f'}} alt=""/>
            </div>
            <div style={{flex:1}}>
              <div style={{fontSize:15,fontWeight:700,marginBottom:2}}>{targetUser.name}</div>
              <div style={{fontSize:10,color:'var(--dim)'}}>{targetUser.handle||''}{targetUser.city?' · 📍'+targetUser.city:''}</div>
            </div>
          </div>
          {/* bio */}
          {fullUser.bio&&<p style={{fontSize:11,color:'rgba(255,255,255,.6)',lineHeight:1.5,marginBottom:8}}>{fullUser.bio}</p>}
          {/* 링크 */}
          {fullUser.link&&<a href={fullUser.link.startsWith('http')?fullUser.link:'https://'+fullUser.link} target="_blank" rel="noopener noreferrer"
            style={{fontSize:11,color:'#a855f7',display:'flex',alignItems:'center',gap:4,marginBottom:8,wordBreak:'break-all'}}>
            🔗 <span style={{textDecoration:'underline',textUnderlineOffset:2}}>{fullUser.link.replace(/^https?:\/\//,'')}</span>
          </a>}
          {/* 도시에서 참여한 릴레이 desc */}
          {!fullUser.bio&&targetUser.desc&&<p style={{fontSize:11,color:'rgba(255,255,255,.55)',lineHeight:1.5,marginBottom:8,fontStyle:'italic'}}>"{targetUser.desc}"</p>}
          {/* 통계 */}
          <div style={{display:'flex',gap:22,marginTop:4}}>
            {[[t.statRelay,userSeeds.length],[t.statFollower,followers>=1000?(followers/1000).toFixed(1)+'K':followers],['km',totalKm>=1000?(totalKm/1000).toFixed(1)+'K':totalKm]].map(([l,v])=>(
              <div key={l}><div style={{fontSize:14,fontWeight:700}}>{v}</div><div style={{fontSize:9,color:'var(--dim)'}}>{l}</div></div>
            ))}
          </div>
        </div>
        {/* 참여한 릴레이 목록 */}
        {userSeeds.length>0&&(
          <div className="sc" style={{flex:1,padding:'10px 20px 12px'}}>
            <div style={{fontSize:9,color:'var(--dim)',letterSpacing:'.07em',marginBottom:10}}>RELAY</div>
            {userSeeds.map(s=>(
              <div key={s.id} onClick={()=>{onOpen&&onOpen(s);onClose();}} style={{display:'flex',gap:10,alignItems:'center',marginBottom:12,cursor:'pointer',borderRadius:10,padding:'4px 6px',margin:'-4px -6px 8px'}}>
                <img src={s.thumb} style={{width:40,height:40,borderRadius:8,objectFit:'cover',opacity:.82,flexShrink:0}} alt=""/>
                <div style={{flex:1,minWidth:0}}>
                  <div style={{fontSize:11,fontWeight:500,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{s.title}</div>
                  <div style={{fontSize:9,color:'var(--dim)'}}>{s.cat} · {s.countries}{t.countries}</div>
                </div>
              </div>
            ))}
          </div>
        )}
        {/* 액션 버튼 */}
        <div style={{padding:'0 20px 36px',flexShrink:0}}>
          {!isMe&&(
            <div style={{display:'flex',gap:8,marginBottom:8}}>
              <button onClick={async()=>{
                // Firestore에 팔로우 저장
                if(window.FB&&currentUser){
                  try{
                    const db=window.FB.db;
                    // 상대방 followerList에 내 정보 추가
                    const targetRef=window.FB.doc(db,'users',targetUser.uid||targetUser.id||'');
                    // 내 followingList에 상대 정보 추가
                    const myRef=window.FB.doc(db,'users',currentUser.uid||currentUser.id||'');
                    const myInfo={name:currentUser.name,handle:currentUser.handle,avatar:currentUser.avatar||''};
                    const targetInfo={name:targetUser.name,handle:targetUser.handle,avatar:targetUser.avatar||''};
                    await window.FB.updateDoc(targetRef,{
                      followers:window.FB.increment(1),
                      followerList:window.FB.arrayUnion?window.FB.arrayUnion(myInfo):[myInfo]
                    }).catch(()=>{});
                    await window.FB.updateDoc(myRef,{
                      followingList:window.FB.arrayUnion?window.FB.arrayUnion(targetInfo):[targetInfo]
                    }).catch(()=>{});
                  }catch(e){}
                }
                alert('팔로우했습니다!');
              }} className="gbtn" style={{flex:1,padding:'11px',borderRadius:12,fontSize:12}}>
                팔로우
              </button>
              <button onClick={()=>{onAsk(targetUser);onClose();}} className="btn" style={{flex:1,padding:'11px',borderRadius:12,fontSize:12,border:'1px solid rgba(168,85,247,.4)'}}>
                버블 보내기
              </button>
            </div>
          )}
          {isMe&&<div style={{fontSize:10,color:'var(--dim)',textAlign:'center',padding:'8px 0'}}>내 프로필</div>}
        </div>
      </div>
    </div>
  );
};

const FullscreenViewer=({seed,initPi=0,onClose,onDetail,currentUser})=>{
  const {t}=useT();
  const [pi,setPi]=useState(initPi);
  const [prog,setProg]=useState(0);
  const [paused,setPaused]=useState(false);
  const [kmKey,setKmKey]=useState(0);
  const [liked,setLiked]=useState({});
  const [fvShare,setFvShare]=useState(null);
  const [isMuted,setIsMuted]=useState(true);
  const [vidLoading,setVidLoading]=useState(false);
  const [isPlaying,setIsPlaying]=useState(false);
  const vidRef=useRef(null);
  const [showComments,setShowComments]=useState(false);
  const [comments,setComments]=useState(seed.comments||[]);
  const [commentText,setCommentText]=useState('');
  const [userProfile,setUserProfile]=useState(null);
  const [askTarget,setAskTarget]=useState(null);
  const touchRef=useRef(null);
  const rafRef=useRef(null);
  const ltRef=useRef(null);
  const pv=useRef(0);
  const parts=seed.participants;
  const cur=parts[pi];
  const totalKm=parts.slice(0,pi+1).reduce((a,p)=>a+p.km,0);
  const mapTx=-(cur.loc.mx*45);
  useEffect(()=>{
    setKmKey(k=>k+1);
    pv.current=0;
    setProg(0);
    const isVid2=parts[pi]&&(parts[pi].isVideo||isVideoUrl(parts[pi].photo));
    setVidLoading(!!isVid2);
    setIsPlaying(false);
    setIsMuted(true);
    if(vidRef.current){vidRef.current.pause();}
    vidRef.current=null;
  },[pi]);
  useEffect(()=>{
    if(paused){cancelAnimationFrame(rafRef.current);ltRef.current=null;return;}
    const tick=(ts)=>{if(!ltRef.current)ltRef.current=ts;const e=ts-ltRef.current;ltRef.current=ts;pv.current=Math.min(pv.current+e/50,100);setProg(pv.current);if(pv.current>=100){pv.current=0;ltRef.current=null;setPi(i=>i+1<parts.length?i+1:0);return;}rafRef.current=requestAnimationFrame(tick);};
    rafRef.current=requestAnimationFrame(tick);
    return()=>{cancelAnimationFrame(rafRef.current);ltRef.current=null;};
  },[pi,paused,parts.length]);
  const sendComment=()=>{if(!commentText.trim())return;setComments(p=>[{id:'c'+Date.now(),user:currentUser?.name||'me',text:commentText.trim(),avatar:currentUser?.avatar||'https://i.pravatar.cc/40?img=50',time:'방금'},...p]);setCommentText('');};
  const onTs=e=>{touchRef.current={x:e.touches[0].clientX,y:e.touches[0].clientY};if(!showComments)setPaused(true);};
  const onTe=e=>{
    if(!touchRef.current)return;
    const dx=e.changedTouches[0].clientX-touchRef.current.x;
    const dy=e.changedTouches[0].clientY-touchRef.current.y;
    if(Math.abs(dy)>100&&Math.abs(dy)>Math.abs(dx)*1.5){onClose();touchRef.current=null;return;}
    if(Math.abs(dx)>40){
      dx<0&&pi<parts.length-1?setPi(i=>i+1):dx>0&&pi>0&&setPi(i=>i-1);
    } else if(Math.abs(dx)<15&&Math.abs(dy)<15){
      // 탭 - isMuted 토글 → key 변경 → 새 video 엘리먼트 (소리 있음)
      setIsMuted(m=>!m);
    }
    setPaused(false);
    touchRef.current=null;
  };
  return(
    <div style={{position:'absolute',inset:0,zIndex:90,background:'#000'}} className="af" onTouchStart={onTs} onTouchEnd={onTe}
>
      <WorldMap tx={mapTx}/>
      {(cur.isVideo||isVideoUrl(cur.photo))?
        <video key={`fs-v-${pi}-${isMuted?'m':'s'}`} src={cur.photo} playsInline autoPlay loop
          onLoadStart={()=>setVidLoading(true)}
          onCanPlay={()=>setVidLoading(false)}
          ref={el=>{
            if(el){
              vidRef.current=el;
              if(isMuted) el.muted=true;
              el.play().catch(()=>{});
            }
          }}
          style={{position:'absolute',inset:0,width:'100%',height:'100%',objectFit:'cover'}}/>
        :<img key={`fs-${pi}`} src={cur.photo} style={{position:'absolute',inset:0,width:'100%',height:'100%',objectFit:'cover'}} alt="" className="af"/>}
      <div style={{position:'absolute',inset:0,background:'linear-gradient(to bottom,rgba(8,0,15,.7)0%,transparent 28%,transparent 52%,rgba(8,0,15,.95)100%)'}}/>
      {vidLoading&&(cur.isVideo||isVideoUrl(cur.photo))&&(
        <div style={{position:'absolute',inset:0,display:'flex',alignItems:'center',justifyContent:'center',zIndex:4,pointerEvents:'none'}}>
          <div style={{width:36,height:36,borderRadius:99,border:'3px solid rgba(168,85,247,.25)',borderTopColor:'#a855f7',animation:'spin 1s linear infinite'}}/>
        </div>
      )}



      <div className="pin" key={`fp-${pi}`} style={{left:`calc(${cur.loc.mx*100}% + ${mapTx*.4}%)`,top:`${cur.loc.my*100}%`}}/>
      <div onClick={()=>pi>0&&setPi(i=>i-1)} style={{position:'absolute',top:0,left:0,width:'35%',height:'100%',zIndex:5}}/>
      <div onClick={()=>pi<parts.length-1&&setPi(i=>i+1)} style={{position:'absolute',top:0,right:0,width:'35%',height:'100%',zIndex:5}}/>
      <div style={{position:'absolute',top:0,left:0,right:0,padding:'16px 16px 0',zIndex:20}}>
        <div style={{display:'flex',gap:3,marginBottom:12}}>
          {parts.map((_,i)=>(
            <div key={i} style={{flex:1,height:2,background:'rgba(255,255,255,.15)',borderRadius:99,overflow:'hidden'}}>
              <div style={{height:'100%',background:'linear-gradient(90deg,#7c3aed,#ec4899)',width:i<pi?'100%':i===pi?`${prog}%`:'0%'}}/>
            </div>
          ))}
        </div>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
          <button onClick={onClose} className="btn" style={{fontSize:24,color:'rgba(255,255,255,.7)',padding:'2px 6px 2px 0'}}>×</button>
          <div style={{textAlign:'center'}}><div style={{fontSize:8,color:'rgba(255,255,255,.4)',marginBottom:1}}>{t.connDist}</div><KmCount target={totalKm} animKey={kmKey}/></div>
          <div style={{textAlign:'right'}}><div style={{fontSize:8,color:'rgba(255,255,255,.4)',marginBottom:1}}>{t.curLoc}</div><div style={{fontSize:10,fontWeight:600}}>{cur.loc.name}</div></div>
        </div>
      </div>
      <div style={{position:'absolute',bottom:0,left:0,right:0,padding:'0 16px 32px',zIndex:20}}>
        <div style={{display:'flex',alignItems:'center',gap:10,marginBottom:8}}>
          <img src={cur.avatar} onClick={e=>{e.stopPropagation();setUserProfile(cur);}} style={{width:30,height:30,borderRadius:99,objectFit:'cover',border:'1.5px solid rgba(168,85,247,.4)',cursor:'pointer'}} alt=""/>
          <div style={{flex:1,cursor:'pointer'}} onClick={e=>{e.stopPropagation();setUserProfile(cur);}}><div style={{fontSize:13,fontWeight:600}}>{cur.name}</div><div style={{fontSize:9,color:'rgba(255,255,255,.45)'}}>{cur.city}{cur.km>0?` · +${(cur.km/1000).toFixed(1)}K km`:''}{pi===0?' · '+t.director:''}</div></div>
        </div>
        <p style={{fontSize:12,color:'rgba(255,255,255,.75)',lineHeight:1.55,marginBottom:4}}>{cur.desc}</p>
        <TranslateBtn text={cur.desc}/>
        <div style={{display:'flex',alignItems:'center',gap:14}}>
          {/* 참여자 아바타 */}
          <div style={{display:'flex',alignItems:'center'}}>
            {parts.slice(0,4).map((p,i)=>(
              <div key={i} onClick={e=>{e.stopPropagation();setPi(i);}} style={{width:22,height:22,borderRadius:99,overflow:'hidden',border:`1.5px solid ${i===pi?'#fff':'rgba(168,85,247,.3)'}`,marginLeft:i>0?-6:0,cursor:'pointer'}}>
                <img src={p.avatar} style={{width:'100%',height:'100%',objectFit:'cover'}} alt=""/>
              </div>
            ))}
            {parts.length>4&&<div style={{fontSize:8,color:'rgba(255,255,255,.4)',marginLeft:5}}>+{parts.length-4}</div>}
            <div style={{fontSize:9,color:'rgba(255,255,255,.35)',marginLeft:6}}>{pi+1}/{parts.length}</div>
          </div>
          <div style={{flex:1}}/>
          {/* 댓글 */}
          <button onClick={e=>{e.stopPropagation();setShowComments(true);setPaused(true);}} className="btn" style={{display:'flex',flexDirection:'column',alignItems:'center',gap:1,padding:'4px'}}>
            <svg width="19" height="19" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,.6)" strokeWidth="1.7"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
            <div style={{fontSize:8,color:'rgba(255,255,255,.4)'}}>{comments.length}</div>
          </button>
          {/* 공유 */}
          <button onClick={e=>{e.stopPropagation();setFvShare(seed);}} className="btn" style={{display:'flex',flexDirection:'column',alignItems:'center',gap:2,padding:'4px 6px'}}>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,.65)" strokeWidth="1.8"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
          </button>
          {/* 좋아요 */}
          <button onClick={e=>{e.stopPropagation();const newVal=!liked[seed.id+pi];setLiked(p=>({...p,[seed.id+pi]:newVal}));if(newVal&&window.FB)window.FB.logEvent(window.FB.analytics,'relay_liked',{relay_id:seed.id,relay_title:seed.title||'unknown',participant_index:pi});}} className="btn" style={{display:'flex',flexDirection:'column',alignItems:'center',gap:1,padding:'4px 6px'}}>
            <span className={`dlike ${liked[seed.id+pi]?'on':'off'}`}/>
            <div style={{fontSize:9,color:'rgba(255,255,255,.4)',marginTop:1}}>{liked[seed.id+pi]?seed.honors+1:seed.honors}</div>
          </button>
        </div>
      </div>
      {/* 댓글 패널 */}
      {showComments&&(
        <div style={{position:'absolute',inset:0,zIndex:93,background:'rgba(8,0,15,.65)'}} onClick={()=>{setShowComments(false);setPaused(false);}}>
          <div style={{position:'absolute',bottom:0,left:0,right:0,background:'#0d0018',borderRadius:'16px 16px 0 0',maxHeight:'65%',display:'flex',flexDirection:'column'}} onClick={e=>e.stopPropagation()} className="asu">
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'14px 16px 10px',flexShrink:0}}>
              <div style={{fontSize:10,fontWeight:700,color:'var(--p)',letterSpacing:'.07em'}}>{t.comments.toUpperCase()} ({comments.length})</div>
              <button onClick={()=>{setShowComments(false);setPaused(false);}} className="btn" style={{fontSize:20,color:'var(--dim)'}}>×</button>
            </div>
            <div style={{display:'flex',gap:8,padding:'0 16px 10px',flexShrink:0,borderBottom:'1px solid rgba(168,85,247,.08)'}}>
              <input className="inp" style={{flex:1,fontSize:11}} placeholder={t.addComment} value={commentText}
                onChange={e=>setCommentText(e.target.value)} onKeyDown={e=>e.key==='Enter'&&sendComment()}/>
              <button onClick={sendComment} className="btn" style={{fontSize:11,fontWeight:700,color:'var(--p)',flexShrink:0}}>{t.send}</button>
            </div>
            <div className="sc" style={{flex:1,padding:'10px 16px 20px'}}>
              {comments.length===0&&<div style={{fontSize:11,color:'var(--dim)',textAlign:'center',paddingTop:20}}>{t.addComment}</div>}
              {comments.map((cm,i)=>(
                <div key={cm.id||i} style={{display:'flex',gap:9,marginBottom:12}}>
                  <img src={cm.avatar} style={{width:24,height:24,borderRadius:99,objectFit:'cover',flexShrink:0}} alt=""/>
                  <div style={{flex:1}}>
                    <div style={{display:'flex',gap:7,alignItems:'baseline',marginBottom:2}}>
                      <span style={{fontSize:11,fontWeight:600}}>{cm.user}</span>
                      <span style={{fontSize:9,color:'var(--dim)'}}>{cm.time}</span>
                    </div>
                    <p style={{fontSize:11,color:'rgba(255,255,255,.65)',lineHeight:1.5}}>{cm.text}</p>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      )}
      {userProfile&&<UserProfile targetUser={userProfile} currentUser={currentUser} seeds={seed.participants?[seed]:undefined} onClose={()=>setUserProfile(null)} onAsk={u=>setAskTarget(u)}/>}
    {fvShare&&<ShareSheet seed={fvShare} onClose={()=>setFvShare(null)}/>}
    </div>
  );
};

const RelayCard=({seed,onFullscreen,onDetail,onJoin,onProfile})=>{
  const {t}=useT();
  const [pi,setPi]=useState(0);
  const [prog,setProg]=useState(0);
  const [kmKey,setKmKey]=useState(0);
  const touchRef=useRef(null);
  const cardRef=useRef(null);
  const activeRef=useRef(false);
  const rafRef=useRef(null);
  const ltRef=useRef(null);
  const pv=useRef(0);
  const parts=seed.participants;
  const cur=parts[pi];
  const totalKm=parts.slice(0,pi+1).reduce((a,p)=>a+p.km,0);
  useEffect(()=>{setKmKey(k=>k+1);pv.current=0;setProg(0);},[pi]);
  useEffect(()=>{const el=cardRef.current;if(!el)return;const obs=new IntersectionObserver(e=>{activeRef.current=e[0].isIntersecting&&e[0].intersectionRatio>.5;},{threshold:.5});obs.observe(el);return()=>obs.disconnect();},[]);
  useEffect(()=>{
    const tick=(ts)=>{if(!activeRef.current){ltRef.current=null;rafRef.current=requestAnimationFrame(tick);return;}if(!ltRef.current)ltRef.current=ts;const e=ts-ltRef.current;ltRef.current=ts;pv.current=Math.min(pv.current+e/50,100);setProg(pv.current);if(pv.current>=100){pv.current=0;ltRef.current=null;setPi(i=>(i+1)%parts.length);}rafRef.current=requestAnimationFrame(tick);};
    rafRef.current=requestAnimationFrame(tick);return()=>cancelAnimationFrame(rafRef.current);
  },[pi,parts.length]);
  const onTs=e=>{touchRef.current=e.touches[0].clientX;ltRef.current=null;};
  const onTe=e=>{if(!touchRef.current)return;const dx=e.changedTouches[0].clientX-touchRef.current;if(Math.abs(dx)>35){dx<0&&pi<parts.length-1?setPi(i=>i+1):dx>0&&pi>0&&setPi(i=>i-1);}touchRef.current=null;};
  const isL=seed.type==='landscape';
  return(
    <div ref={cardRef}>
      <div style={{position:'relative',width:'100%',paddingTop:isL?'56.25%':'125%',background:'#0d0018'}}
        onTouchStart={onTs} onTouchEnd={onTe} onClick={()=>onFullscreen(seed,pi)}>
        <div style={{position:'absolute',inset:0}}>
          {(cur.isVideo||isVideoUrl(cur.photo))?<video key={`c-v-${seed.id}-${pi}`} src={cur.photo} muted playsInline autoPlay loop style={{width:'100%',height:'100%',objectFit:'cover',opacity:.88,display:'block'}}/>:<img key={`c-${seed.id}-${pi}`} src={cur.photo} style={{width:'100%',height:'100%',objectFit:'cover',opacity:.88,display:'block'}} alt="" className="af"/>}
          <div style={{position:'absolute',inset:0,background:'linear-gradient(to bottom,rgba(8,0,15,.45)0%,transparent 36%,transparent 52%,rgba(8,0,15,.9)100%)'}}/>
          <div style={{position:'absolute',top:10,left:12,right:12,display:'flex',gap:3,zIndex:5}}>
            {parts.map((_,i)=>(
              <div key={i} style={{flex:1,height:1.5,background:'rgba(255,255,255,.18)',borderRadius:99,overflow:'hidden'}}>
                <div style={{height:'100%',background:'linear-gradient(90deg,#7c3aed,#ec4899)',width:i<pi?'100%':i===pi?`${prog}%`:'0%'}}/>
              </div>
            ))}
          </div>
          <div style={{position:'absolute',top:20,left:12,right:12,display:'flex',justifyContent:'space-between',zIndex:5}}>
            <div><div style={{fontSize:8,color:'rgba(255,255,255,.4)',marginBottom:1}}>{t.connDist}</div><KmCount target={totalKm} animKey={kmKey}/></div>
            <div style={{textAlign:'right'}}><div style={{fontSize:8,color:'rgba(255,255,255,.4)',marginBottom:1}}>{t.curLoc}</div><div style={{fontSize:10,fontWeight:600}}>{cur.loc.name}</div></div>
          </div>
          <div style={{position:'absolute',bottom:12,left:12,right:12,zIndex:5}}>
            <div style={{display:'flex',alignItems:'center',gap:7,marginBottom:5,cursor:'pointer'}} onClick={e=>{e.stopPropagation();onProfile&&onProfile(cur);}}>
              <img src={cur.avatar} style={{width:22,height:22,borderRadius:99,objectFit:'cover',border:'1px solid rgba(168,85,247,.4)'}} alt=""/>
              <div style={{fontSize:11,fontWeight:600}}>{cur.name}</div>
              {pi===0&&<div style={{fontSize:8,color:'var(--p)'}}>{t.director}</div>}
            </div>
            <div style={{fontSize:11,color:'rgba(255,255,255,.75)',lineHeight:1.45}}>{cur.desc}</div>
          </div>
        </div>
      </div>
      <div style={{padding:'10px 14px 14px',display:'flex',alignItems:'center',gap:12,borderBottom:'1px solid rgba(168,85,247,.08)'}}>
        <img src={seed.avatar} style={{width:28,height:28,borderRadius:99,objectFit:'cover',flexShrink:0}} alt=""/>
        <div style={{flex:1,minWidth:0}}>
          <div style={{fontSize:12,fontWeight:600,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{seed.title}</div>
          <div style={{fontSize:9,color:'var(--dim)'}}>{seed.name} · {seed.cat} · {seed.countries}{t.countries}</div>
        </div>
        <div style={{display:'flex',alignItems:'center',gap:14,flexShrink:0}}>
          <div style={{display:'flex',alignItems:'center'}}>{parts.slice(0,4).map((p,i)=><img key={i} src={p.avatar} style={{width:17,height:17,borderRadius:99,objectFit:'cover',marginLeft:i>0?-6:0,border:'1.5px solid #08000f'}} alt=""/>)}{parts.length>4&&<div style={{fontSize:8,color:'var(--dim)',marginLeft:4}}>+{parts.length-4}</div>}</div>

          <button onClick={e=>{e.stopPropagation();onJoin&&onJoin(seed);}} className="btn"
            style={{padding:'5px 12px',borderRadius:99,border:'1px solid rgba(168,85,247,.35)',fontSize:10,fontWeight:700,color:'var(--p)'}}>
            {t.join}
          </button>
        </div>
      </div>
    </div>
  );
};

const HomeFeed=({seeds,onDetail,onNotif,unread,onJoin,currentUser,onAsk})=>{
  const {t}=useT();
  const [fs,setFs]=useState(null);
  const [hfProfile,setHfProfile]=useState(null);
  return(
    <div style={{flex:1,display:'flex',flexDirection:'column',overflow:'hidden',position:'relative'}}>
      <div style={{padding:'14px 18px 11px',display:'flex',alignItems:'center',justifyContent:'space-between',flexShrink:0,borderBottom:'1px solid rgba(168,85,247,.1)'}}>
        <div>
          <div style={{fontSize:22,fontWeight:900,letterSpacing:-1,background:'linear-gradient(135deg,#a855f7,#f472b6)',WebkitBackgroundClip:'text',WebkitTextFillColor:'transparent',backgroundClip:'text'}}>Kmilo</div>
          <div style={{fontSize:9,color:'rgba(168,85,247,.45)',letterSpacing:'.16em'}}>GLOBAL RELAY</div>
        </div>
        <button onClick={onNotif} className="btn" style={{fontSize:10,color:'rgba(255,255,255,.32)',display:'flex',alignItems:'center',gap:6}}>
          {t.notification}{unread>0&&<span style={{padding:'1px 5px',borderRadius:99,background:'linear-gradient(135deg,#7c3aed,#ec4899)',fontSize:9,color:'#fff'}}>{unread}</span>}
        </button>
      </div>
      <div className="sc" style={{flex:1}}>
        {seeds.map(s=><RelayCard key={s.id} seed={s} onFullscreen={(s,pi)=>setFs({seed:s,pi})} onDetail={onDetail} onJoin={onJoin} onProfile={setHfProfile}/>)}
        <div style={{height:24}}/>
      </div>
      {fs&&<FullscreenViewer seed={fs.seed} initPi={fs.pi} onClose={()=>setFs(null)} onDetail={s=>{setFs(null);onDetail(s);}} currentUser={currentUser}/>}
      {hfProfile&&<UserProfile targetUser={hfProfile} currentUser={currentUser} seeds={seeds} onClose={()=>setHfProfile(null)} onAsk={(u)=>{setHfProfile(null);onAsk&&onAsk(u);}} onOpen={onDetail}/>}
    </div>
  );
};

/* ═══ SEED DETAIL ═══ */
const SeedDetail=({seed,onBack,onDelete,currentUser,onAsk})=>{
  const {t}=useT();
  const [pi,setPi]=useState(0);
  const [kmKey,setKmKey]=useState(0);
  const [tab,setTab]=useState('journey');
  const [comment,setComment]=useState('');
  const [comments,setComments]=useState(seed.comments||[]);
  const [liked,setLiked]=useState({});
  const [sdShare,setSdShare]=useState(false);
  const [isMuted,setIsMuted]=useState(true);
  const [vidLoading,setVidLoading]=useState(false);
  const [isPlaying,setIsPlaying]=useState(false);
  const [userProfile,setUserProfile]=useState(null);
  const vidRef=useRef(null);
  const touchRef=useRef(null);
  const mapTx=useRef(0);
  const parts=seed.participants||[];
  const cur=parts[pi]||{};
  const totalKm=parts.slice(0,pi+1).reduce((a,p)=>a+(p.km||0),0);

  // pi 바뀔 때 지도 애니메이션
  useEffect(()=>{
    if(cur.loc){
      const tx=cur.loc.mx>0.5?-(cur.loc.mx-0.5)*40:0;
      mapTx.current=tx;
    }
    setKmKey(k=>k+1);
  },[pi]);

  // 자동 슬라이드 (5초마다)
  useEffect(()=>{
    if(parts.length<=1)return;
    const timer=setInterval(()=>{
      setPi(i=>i<parts.length-1?i+1:0);
    },5000);
    return()=>clearInterval(timer);
  },[parts.length]);

  const onTs=e=>{touchRef.current={x:e.touches[0].clientX,y:e.touches[0].clientY};};
  const onTe=e=>{
    if(!touchRef.current)return;
    const dx=e.changedTouches[0].clientX-touchRef.current.x;
    const dy=e.changedTouches[0].clientY-touchRef.current.y;
    if(Math.abs(dx)>40){
      dx<0?setPi(i=>Math.min(i+1,parts.length-1)):setPi(i=>Math.max(i-1,0));
    } else if(Math.abs(dx)<15&&Math.abs(dy)<15&&isVid){
      setIsMuted(m=>!m);
    }
    touchRef.current=null;
  };

  const send=()=>{
    if(!comment.trim())return;
    setComments(prev=>[...prev,{id:Date.now(),user:currentUser?.name||'나',avatar:currentUser?.avatar||'https://i.pravatar.cc/40',text:comment,time:'방금'}]);
    setComment('');
  };

  const toggleMute=()=>{
    if(vidRef.current){const newMuted=!isMuted;vidRef.current.muted=newMuted;if(!newMuted){vidRef.current.play().catch(()=>{});}setIsMuted(newMuted);}
  };

  const isVid=cur.isVideo||isVideoUrl(cur.photo);

  return(
    <div style={{flex:1,display:'flex',flexDirection:'column',overflow:'hidden'}} className="asu" onTouchStart={onTs} onTouchEnd={onTe}>
      {/* 미디어 영역 */}
      <div style={{position:'relative',width:'100%',paddingTop:seed.type==='landscape'?'56.25%':'100%',background:'#0d0018',flexShrink:0}}>
        <div style={{position:'absolute',inset:0}}>
          <WorldMap tx={mapTx.current}/>
          {vidLoading&&isVid&&(
            <div style={{position:'absolute',inset:0,display:'flex',alignItems:'center',justifyContent:'center',zIndex:6,pointerEvents:'none'}}>
              <div style={{width:36,height:36,borderRadius:99,border:'3px solid rgba(168,85,247,.25)',borderTopColor:'#a855f7',animation:'spin 1s linear infinite'}}/>
            </div>
          )}


          {isVid
            ?<video key={`sd-v-${pi}-${isMuted?'m':'s'}`} src={cur.photo} playsInline autoPlay loop
                onLoadStart={()=>setVidLoading(true)}
                onCanPlay={()=>setVidLoading(false)}
                ref={el=>{
                  if(el){
                    vidRef.current=el;
                    if(isMuted) el.muted=true;
                    el.play().catch(()=>{});
                  }
                }}
                style={{width:'100%',height:'100%',objectFit:'cover',opacity:.88,display:'block'}}/>
            :<img key={pi} src={cur.photo} style={{width:'100%',height:'100%',objectFit:'cover',opacity:.72,display:'block'}} alt="" className="af"/>
          }
          <div style={{position:'absolute',inset:0,background:'linear-gradient(to bottom,rgba(8,0,15,.62)0%,transparent 40%,rgba(8,0,15,.75)100%)'}}/>
          <div className="pin" key={`dp-${pi}`} style={{left:`calc(${(cur.loc||{mx:0}).mx*100}% + ${mapTx.current*.4}%)`,top:`${(cur.loc||{my:0.5}).my*100}%`}}/>

          {/* 상단 바 */}
          <div style={{position:'absolute',top:14,left:14,right:14,zIndex:10}}>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:10}}>
              <button onClick={onBack} className="btn" style={{fontSize:11,color:'rgba(255,255,255,.55)'}}>{t.back}</button>
              {onDelete&&currentUser&&seed.uid===currentUser.id&&
                <button onClick={()=>{if(confirm('삭제하시겠어요?')){onDelete(seed.id);onBack();}}} className="btn" style={{fontSize:16,color:'rgba(255,80,80,.5)',padding:'2px 8px',lineHeight:1}}>×</button>}
              <KmCount target={totalKm} animKey={kmKey}/>
              <div style={{fontSize:10,color:'rgba(255,255,255,.45)'}}>{(cur.loc||{name:''}).name}</div>
            </div>
            {/* 프로그레스 바 */}
            <div style={{display:'flex',gap:3}}>
              {parts.map((_,i)=>(
                <div key={i} onClick={()=>setPi(i)} style={{flex:1,height:2,background:'rgba(255,255,255,.15)',borderRadius:99,cursor:'pointer',overflow:'hidden'}}>
                  <div style={{height:'100%',background:'linear-gradient(90deg,#7c3aed,#ec4899)',width:i<=pi?'100%':'0%',transition:'width .25s'}}/>
                </div>
              ))}
            </div>
          </div>

          {/* 하단 작성자 */}
          <div style={{position:'absolute',bottom:12,left:14,right:60,zIndex:10,display:'flex',alignItems:'center',gap:8}}>
            <img src={cur.avatar} onClick={()=>cur.name&&setUserProfile(cur)} style={{width:26,height:26,borderRadius:99,objectFit:'cover',border:'1px solid rgba(168,85,247,.4)',cursor:'pointer',flexShrink:0}} alt=""/>
            <div>
              <div style={{fontSize:12,fontWeight:600}}>{cur.name}</div>
              <div style={{fontSize:9,color:'rgba(255,255,255,.4)'}}>{cur.city}{cur.km>0?` · +${(cur.km/1000).toFixed(1)}K km`:''}</div>
            </div>
          </div>

          {/* 우측 액션 버튼들 */}
          <div style={{position:'absolute',bottom:8,right:10,zIndex:10,display:'flex',flexDirection:'column',alignItems:'center',gap:14}}>

            {/* 좋아요 */}
            <button onClick={e=>{e.stopPropagation();const newVal=!liked[seed.id+pi];setLiked(p=>({...p,[seed.id+pi]:newVal}));if(newVal&&window.FB)window.FB.logEvent(window.FB.analytics,'relay_liked',{relay_id:seed.id,relay_title:seed.title||'unknown',participant_index:pi});}} className="btn" style={{display:'flex',flexDirection:'column',alignItems:'center',gap:2,padding:0}}>
              <span className={`dlike ${liked[seed.id+pi]?'on':'off'}`}/>
              <div style={{fontSize:9,color:'rgba(255,255,255,.45)',marginTop:1}}>{liked[seed.id+pi]?seed.honors+1:seed.honors}</div>
            </button>
            {/* 공유 */}
            <button onClick={e=>{e.stopPropagation();setSdShare(true);}} className="btn" style={{display:'flex',flexDirection:'column',alignItems:'center',gap:2,padding:0}}>
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,.6)" strokeWidth="1.8"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
            </button>
          </div>

          {/* 이전/다음 클릭 영역 */}
          <div onClick={()=>pi>0&&setPi(i=>i-1)} style={{position:'absolute',top:60,bottom:60,left:0,width:'35%',zIndex:5}}/>
          <div onClick={()=>pi<parts.length-1&&setPi(i=>i+1)} style={{position:'absolute',top:60,bottom:60,right:0,width:'35%',zIndex:5}}/>
        </div>
      </div>

      {/* 설명 */}
      <div style={{padding:'11px 16px 9px',borderBottom:'1px solid rgba(168,85,247,.08)',flexShrink:0}}>
        <p style={{fontSize:12,color:'rgba(255,255,255,.6)',lineHeight:1.6}}>{cur.desc}</p>
        <TranslateBtn text={cur.desc||''}/>
      </div>

      {/* 탭 */}
      <div style={{display:'flex',borderBottom:'1px solid rgba(168,85,247,.08)',flexShrink:0}}>
        {[['journey',t.relayJourney],['comments',`${t.comments} (${comments.length})`]].map(([k,label])=>(
          <button key={k} onClick={()=>setTab(k)} className="btn"
            style={{flex:1,height:36,fontSize:10,fontWeight:tab===k?700:400,color:tab===k?'var(--p)':'var(--dim)',borderBottom:tab===k?'1px solid var(--p)':'none'}}>
            {label}
          </button>
        ))}
      </div>

      {/* 내용 */}
      <div className="sc" style={{flex:1,padding:'12px 16px 16px'}}>
        {tab==='journey'&&parts.map((p,i)=>(
          <div key={i} style={{display:'flex',gap:12,paddingBottom:i<parts.length-1?14:0,marginBottom:i<parts.length-1?14:0,borderBottom:i<parts.length-1?'1px solid rgba(168,85,247,.06)':'none',opacity:i>pi?.32:1}}>
            <div style={{position:'relative',flexShrink:0,cursor:'pointer'}} onClick={()=>setUserProfile(p)}>
              <img src={p.avatar} style={{width:28,height:28,borderRadius:99,objectFit:'cover'}} alt=""/>
              {i<parts.length-1&&<div style={{position:'absolute',left:'50%',top:32,width:1,height:12,background:'rgba(168,85,247,.15)',transform:'translateX(-50%)'}}/>}
            </div>
            <div style={{flex:1}}>
              <div style={{display:'flex',justifyContent:'space-between',marginBottom:1}}>
                <div style={{fontSize:12,fontWeight:i===0?700:400,cursor:'pointer'}} onClick={()=>setUserProfile(p)}>{p.name}{i===0&&<span style={{fontSize:8,color:'var(--p)',fontWeight:400,marginLeft:5}}>{t.director}</span>}</div>
                {p.km>0&&<div style={{fontSize:9,color:'var(--dim)',fontFamily:'monospace'}}>+{(p.km/1000).toFixed(1)}K km</div>}
              </div>
              <div style={{fontSize:10,color:'var(--dim)'}}>{p.city}</div>
            </div>
          </div>
        ))}
        {tab==='comments'&&(<>
          <div style={{display:'flex',gap:8,alignItems:'center',marginBottom:14,paddingBottom:12,borderBottom:'1px solid rgba(168,85,247,.08)'}}>
            <input className="inp" style={{flex:1}} placeholder={t.addComment} value={comment} onChange={e=>setComment(e.target.value)} onKeyDown={e=>e.key==='Enter'&&send()}/>
            <button onClick={send} className="btn" style={{fontSize:11,fontWeight:700,color:'var(--p)',flexShrink:0}}>{t.send}</button>
          </div>
          {comments.map(cm=>(
            <div key={cm.id} style={{display:'flex',gap:9,marginBottom:14}}>
              <img src={cm.avatar} style={{width:24,height:24,borderRadius:99,objectFit:'cover',flexShrink:0}} alt=""/>
              <div style={{flex:1}}>
                <div style={{display:'flex',gap:7,alignItems:'baseline',marginBottom:2}}><span style={{fontSize:11,fontWeight:600}}>{cm.user}</span><span style={{fontSize:9,color:'var(--dim)'}}>{cm.time}</span></div>
                <p style={{fontSize:11,color:'rgba(255,255,255,.65)',lineHeight:1.5,marginBottom:2}}>{cm.text}</p>
                <TranslateBtn text={cm.text}/>
              </div>
            </div>
          ))}
        </>)}
      </div>

      {userProfile&&<UserProfile targetUser={userProfile} currentUser={currentUser} seeds={[seed]} onClose={()=>setUserProfile(null)} onAsk={onAsk} onOpen={()=>{}}/>}
      {askTarget&&<AskModal creator={askTarget} onClose={()=>setAskTarget(null)} onSend={()=>setAskTarget(null)}/>}
      {sdShare&&<ShareSheet seed={seed} onClose={()=>setSdShare(false)}/>}
    </div>
  );
};


/* ═══ PROFILE ═══ */
const Explore=({seeds,onOpen,onJoin,currentUser,onAsk})=>{
  const {t}=useT();
  const [q,setQ]=useState('');
  const [fs,setFs]=useState(null);
  const list=q?seeds.filter(s=>{const ql=q.replace(/^[#@]+/,'').toLowerCase();return s.title.toLowerCase().includes(ql)||s.name.toLowerCase().includes(ql)||(s.cat&&s.cat.toLowerCase().includes(ql))||(s.handle&&s.handle.toLowerCase().includes(ql))||(s.place&&s.place.toLowerCase().includes(ql));}):[...seeds].sort((a,b)=>b.honors-a.honors);
  return(
    <div style={{flex:1,display:'flex',flexDirection:'column',overflow:'hidden',position:'relative'}}>
      <div style={{padding:'16px 18px 0',flexShrink:0}}>
        <div style={{fontSize:10,color:'var(--p)',marginBottom:12,letterSpacing:'.08em'}}>EXPLORE</div>
        <input className="inp" placeholder={t.explore+'…'} value={q} onChange={e=>setQ(e.target.value)} style={{marginBottom:16}}/>
        {!q&&<div style={{fontSize:9,color:'var(--dim)',letterSpacing:'.07em',marginBottom:10}}>{t.trending.toUpperCase()}</div>}
      </div>
      <div className="sc" style={{flex:1,padding:'0 18px 20px'}}>
        {list.length===0&&<div style={{fontSize:12,color:'var(--dim)',padding:'40px 0',textAlign:'center'}}>{t.noResult}</div>}
        {list.map((s,i)=>(
          <div key={s.id} style={{display:'flex',gap:12,alignItems:'center',padding:'12px 0',borderBottom:'1px solid rgba(168,85,247,.07)'}}>
            {!q&&<div style={{fontSize:12,fontWeight:700,color:'rgba(168,85,247,.25)',width:16,textAlign:'center',flexShrink:0}}>{i+1}</div>}
            <img src={s.thumb} onClick={()=>setFs({seed:s,pi:0})} style={{width:44,height:44,borderRadius:8,objectFit:'cover',opacity:.85,flexShrink:0,cursor:'pointer'}} alt=""/>
            <div style={{flex:1,minWidth:0,cursor:'pointer'}} onClick={()=>setFs({seed:s,pi:0})}>
              <div style={{fontSize:12,fontWeight:500,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap',marginBottom:2}}>{s.title}</div>
              <div style={{fontSize:10,color:'var(--dim)'}}>{s.name} · {s.countries}{t.countries} · {(s.totalKm/1000).toFixed(1)}K km</div>
            </div>
            <button onClick={()=>onJoin&&onJoin(s)} className="btn"
              style={{fontSize:9,fontWeight:700,color:'var(--p)',padding:'5px 10px',borderRadius:99,border:'1px solid rgba(168,85,247,.3)',flexShrink:0}}>
              {t.join}
            </button>
          </div>
        ))}
      </div>
    {fs&&<FullscreenViewer seed={fs.seed} initPi={fs.pi} onClose={()=>setFs(null)} onDetail={s=>{setFs(null);onOpen(s);}} currentUser={currentUser}/>}
    </div>
  );
};

/* ═══ LEGACY ═══ */
const Legacy=({user,seeds,onOpen,onAsk})=>{
  const {t}=useT();
  const [legProfile,setLegProfile]=useState(null);
  const mine=seeds.filter(s=>s.uid===user.id);
  const tkm=mine.reduce((a,s)=>a+s.totalKm,0);
  const LB=[{rank:1,name:'Alex Kim',handle:'@alexkim',km:'124.2K'},{rank:2,name:'Yuki T.',handle:'@yukisounds',km:'118.7K'},{rank:3,name:'Maria S.',handle:'@mariasounds',km:'104.3K'},{rank:4,name:'Jimin Lee',handle:'@jiminlee',km:'86.3K'},{rank:5,name:'Lena M.',handle:'@lenaberlin',km:'79.1K'}];
  return(
    <div style={{flex:1,display:'flex',flexDirection:'column',overflow:'hidden',position:'relative'}}>
      <div style={{padding:'16px 18px 18px',background:'linear-gradient(180deg,rgba(124,58,237,.1)0%,transparent 100%)',flexShrink:0}}>
        <div style={{fontSize:10,color:'var(--p)',marginBottom:12,letterSpacing:'.08em'}}>LEGACY</div>
        <div style={{fontSize:9,color:'var(--dim)',marginBottom:4}}>{t.totalDist}</div>
        <div style={{fontSize:32,fontWeight:800,letterSpacing:-1,lineHeight:1,background:'linear-gradient(135deg,#a855f7,#f472b6)',WebkitBackgroundClip:'text',WebkitTextFillColor:'transparent',backgroundClip:'text'}}>
          {(tkm/1000).toFixed(1)} <span style={{fontSize:14,fontWeight:400}}>K km</span>
        </div>
      </div>
      <div className="sep" style={{flexShrink:0}}/>
      <div className="sc" style={{flex:1,padding:'14px 18px 20px'}}>
        <div style={{fontSize:9,color:'var(--dim)',letterSpacing:'.07em',marginBottom:12}}>{t.globalRank.toUpperCase()}</div>
        {LB.map((u,i)=>(
          <div key={i} style={{display:'flex',alignItems:'center',gap:11,padding:'10px 0',borderBottom:'1px solid rgba(168,85,247,.07)',opacity:u.handle===user.handle?1:.35}}>
            <div style={{fontSize:10,fontWeight:700,color:'rgba(168,85,247,.35)',width:14,textAlign:'center'}}>{u.rank}</div>
            <div style={{flex:1,cursor:'pointer'}} onClick={()=>setLegProfile(u)}><div style={{fontSize:12,fontWeight:u.handle===user.handle?700:400}}>{u.name}{u.handle===user.handle&&<span style={{fontSize:9,color:'var(--p)',marginLeft:6}}>← 나</span>}</div></div>
            <div style={{fontSize:11,fontFamily:'monospace',color:'var(--dim)'}}>{u.km}</div>
          </div>
        ))}
        {mine.length>0&&<>
          <div style={{fontSize:9,color:'var(--dim)',letterSpacing:'.07em',marginTop:22,marginBottom:12}}>{t.myRelay.toUpperCase()}</div>
          {mine.map(s=>(
            <div key={s.id} onClick={()=>onOpen&&onOpen(s)} style={{display:'flex',gap:12,alignItems:'center',padding:'10px 0',borderBottom:'1px solid rgba(168,85,247,.07)',cursor:'pointer'}}>
              <img src={s.thumb} style={{width:36,height:36,borderRadius:6,objectFit:'cover',opacity:.8}} alt=""/>
              <div style={{flex:1,minWidth:0}}>
                <div style={{fontSize:12,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap',marginBottom:1}}>{s.title}</div>
                <div style={{fontSize:10,color:'var(--dim)'}}>{s.participants.length}명 · {(s.totalKm/1000).toFixed(1)}K km</div>
              </div>
            </div>
          ))}
        </>}
      </div>
    {legProfile&&<UserProfile targetUser={legProfile} currentUser={user} seeds={seeds} onClose={()=>setLegProfile(null)} onAsk={onAsk} onAsk={()=>{}} onOpen={onOpen}/>}
    </div>
  );
};

/* ═══ UPLOAD ═══ */
const Profile=({user,seeds,onLogout,onOpen,onDelete,onUpdateUser})=>{
  const {t}=useT();
  const [editing,setEditing]=useState(false);
  const [name,setName]=useState(user.name);
  const [bio,setBio]=useState(user.bio||'');
  const [link,setLink]=useState(user.link||'');
  const [avatar,setAvatar]=useState(user.avatar);
  const [bubbles,setBubbles]=useState([]);
  const [inboxOpen,setInboxOpen]=useState(false);
  const [replyModal,setReplyModal]=useState(null);
  const [askModal,setAskModal]=useState(null);
  const [followListModal,setFollowListModal]=useState(null); // {type:'followers'|'following', list:[]}
  const avatarRef=useRef(null);

  // Firebase에서 내 버블(받은 질문) 실시간 로드
  useEffect(()=>{
    if(!window.FB||!user.handle)return;
    const q=window.FB.query(
      window.FB.collection(window.FB.db,'bubbles'),
      window.FB.orderBy('createdAt','desc')
    );
    const unsub=window.FB.onSnapshot(q,snap=>{
      const all=snap.docs.map(d=>({...d.data(),id:d.id}));
      // 내 handle로 온 버블만
      setBubbles(all.filter(b=>b.creatorHandle===user.handle));
    });
    return()=>unsub();
  },[user.handle]);

  const mine=seeds.filter(s=>s.uid===user.uid||s.uid===user.id||s.authorUid===user.uid);
  const joined=seeds.filter(s=>s.uid!==user.id&&s.uid!==user.uid&&s.participants&&s.participants.some(p=>p.name===user.name));

  const onAvatarFile=async e=>{
    const f=e.target.files[0];
    if(!f||!f.type.startsWith('image/'))return;
    const compress=(file)=>new Promise(res=>{
      const img=new Image();
      const url=URL.createObjectURL(file);
      img.onload=()=>{
        const canvas=document.createElement('canvas');
        const size=200; canvas.width=size; canvas.height=size;
        const ctx=canvas.getContext('2d');
        const min=Math.min(img.width,img.height);
        const sx=(img.width-min)/2; const sy=(img.height-min)/2;
        ctx.drawImage(img,sx,sy,min,min,0,0,size,size);
        URL.revokeObjectURL(url);
        res(canvas.toDataURL('image/jpeg',0.7));
      };
      img.src=url;
    });
    try{
      const base64=await compress(f);
      setAvatar(base64);
      if(window.FB&&user.uid){
        await window.FB.updateDoc(window.FB.doc(window.FB.db,'users',user.uid),{avatar:base64});
        if(typeof onUpdateUser==='function') onUpdateUser({...user,avatar:base64});
      }
    }catch(err){console.log('avatar error:',err);}
  };

  const saveProfile=async()=>{
    const updated={...user,name,bio,link,avatar};
    if(window.FB&&user.uid){
      try{await window.FB.updateDoc(window.FB.doc(window.FB.db,'users',user.uid),{name,bio,link,avatar});}catch(e){}
    }
    if(typeof onUpdateUser==='function') onUpdateUser(updated);
    setEditing(false);
  };

  // 버블 전송 (AskModal에서 호출)
  const handleAsk=async(text,targetUser)=>{
    const bubble={
      creatorHandle:targetUser?.handle||user.handle,
      creatorUid:targetUser?.uid||user.uid,
      creator:{name:targetUser?.name||user.name,handle:targetUser?.handle||user.handle,avatar:targetUser?.avatar||user.avatar},
      question:text,
      askerName:'익명',
      askerUid:user.uid||'',
      answers:[],
      publicAnswer:null,
      createdAt:window.FB?window.FB.serverTimestamp():Date.now(),
      expiresAt:Date.now()+86400000,
    };
    if(window.FB){
      try{await window.FB.addDoc(window.FB.collection(window.FB.db,'bubbles'),bubble);}
      catch(e){console.log('bubble send error:',e);}
    }
    setAskModal(false);
  };

  // 버블 답변
  const handleReply=async(bid,type,text)=>{
    const bub=bubbles.find(b=>b.id===bid);
    const update=type==='public'
      ?{publicAnswer:{id:'pa'+Date.now(),type:'public',text,createdAt:Date.now()}}
      :{answers:[...(bub?.answers||[]),{id:'a'+Date.now(),type:'private',to:user.id,text,createdAt:Date.now()}]};
    if(window.FB){
      try{await window.FB.updateDoc(window.FB.doc(window.FB.db,'bubbles',bid),update);}
      catch(e){console.log('reply error:',e);}
    }
    setReplyModal(null);
  };

  const unread=bubbles.filter(b=>!b.publicAnswer&&(!b.answers||!b.answers.some(a=>a.to===user.id))).length;

  return(
    <div style={{flex:1,display:'flex',flexDirection:'column',overflow:'hidden'}}>
      <div className="sc" style={{flex:1}}>
        {/* 헤더 */}
        <div style={{padding:'20px 18px 0',display:'flex',justifyContent:'space-between',alignItems:'flex-start'}}>
          <div style={{display:'flex',gap:14,alignItems:'center'}}>
            <div style={{position:'relative',cursor:editing?'pointer':'default'}} onClick={()=>editing&&avatarRef.current?.click()}>
              <div style={{position:'relative',width:52,height:52}}>
                <img src={avatar} style={{position:'relative',width:52,height:52,borderRadius:99,objectFit:'cover',border:'1.5px solid rgba(168,85,247,.35)'}} alt=""/>
                {editing&&<div style={{position:'absolute',inset:0,borderRadius:99,background:'rgba(0,0,0,.4)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:16}}>✏️</div>}
              </div>
            </div>
            <div>
              {editing?<input className="inp" value={name} onChange={e=>setName(e.target.value)} style={{fontSize:14,fontWeight:700,padding:'4px 8px',marginBottom:4,width:140}}/>
                :<div style={{fontSize:15,fontWeight:700}}>{name}</div>}
              <div style={{fontSize:10,color:'var(--dim)'}}>{user.handle}</div>
            </div>
          </div>
          <div style={{display:'flex',gap:8,alignItems:'center'}}>

            {editing
              ?<button onClick={saveProfile} className="gbtn" style={{fontSize:11,padding:'6px 14px',borderRadius:99}}>저장</button>
              :<button onClick={()=>setEditing(true)} className="btn" style={{fontSize:11,color:'var(--dim)',border:'1px solid rgba(168,85,247,.2)',padding:'6px 12px',borderRadius:99}}>편집</button>}
          </div>
        </div>
        <input ref={avatarRef} type="file" accept="image/*" style={{display:'none'}} onChange={onAvatarFile}/>

        {/* 바이오 */}
        <div style={{padding:'12px 18px 0'}}>
          {editing?<textarea className="inp" value={bio} onChange={e=>setBio(e.target.value)} placeholder="소개" style={{width:'100%',minHeight:48,fontSize:11,resize:'none'}}/>
            :<div style={{fontSize:11,color:'rgba(255,255,255,.55)',lineHeight:1.6}}>{bio}</div>}
          {editing&&<input className="inp" value={link} onChange={e=>setLink(e.target.value)} placeholder="링크" style={{marginTop:6,fontSize:11}}/>}
          {!editing&&link&&<a href={link.startsWith('http')?link:'https://'+link} target="_blank" rel="noreferrer" style={{fontSize:10,color:'#a855f7',marginTop:4,display:'block',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{link}</a>}
        </div>

        {/* 통계 */}
        <div style={{padding:'14px 18px 0',display:'flex',gap:24}}>
          {/* 릴레이 */}
          <div style={{textAlign:'center'}}>
            <div style={{fontSize:16,fontWeight:700}}>{mine.length}</div>
            <div style={{fontSize:9,color:'var(--dim)'}}>{t.statRelay||'릴레이'}</div>
          </div>
          {/* 팔로워 - 클릭시 리스트 */}
          <div style={{textAlign:'center',cursor:'pointer'}} onClick={()=>setFollowListModal({type:'followers',list:user.followerList||[]})}>
            <div style={{fontSize:16,fontWeight:700}}>{user.followers>=1000?(user.followers/1000).toFixed(1)+'K':user.followers||0}</div>
            <div style={{fontSize:9,color:'var(--dim)'}}>{t.statFollower||'팔로워'}</div>
          </div>
          {/* 팔로잉 - 클릭시 리스트 */}
          <div style={{textAlign:'center',cursor:'pointer'}} onClick={()=>setFollowListModal({type:'following',list:user.followingList||[]})}>
            <div style={{fontSize:16,fontWeight:700}}>{(user.followingList||[]).length}</div>
            <div style={{fontSize:9,color:'var(--dim)'}}>팔로잉</div>
          </div>
          {/* km */}
          <div style={{textAlign:'center'}}>
            <div style={{fontSize:16,fontWeight:700}}>{(()=>{const total=seeds.filter(s=>s.uid===user.uid||s.uid===user.id||s.authorUid===user.uid).reduce((a,s)=>{const p=s.participants?.find(p=>p.uid===user.uid||p.name===user.name);return a+(p?.km||0);},0);return total>=1000?(total/1000).toFixed(1)+'K':total;})()}</div>
            <div style={{fontSize:9,color:'var(--dim)'}}>km</div>
          </div>
        </div>

        {/* 버블 섹션 (공개 Q&A) */}
        <BubbleSection
          bubbles={bubbles}
          user={user}
          isOwn={true}
          onAsk={()=>setAskModal({target:user})}
          onOpenInbox={()=>setInboxOpen(true)}
          onReply={(b,type)=>setReplyModal({bubble:b,type})}
        />

        {/* 내 릴레이 */}
        <div style={{padding:'16px 18px 0'}}>
          <div style={{fontSize:10,fontWeight:700,color:'var(--dim)',letterSpacing:'.08em',marginBottom:10}}>{t.director||'디렉터'}</div>
          <div style={{display:'flex',flexDirection:'column',gap:8}}>
            {mine.length===0&&<div style={{fontSize:11,color:'var(--dim)',padding:'8px 0'}}>아직 만든 릴레이가 없어요</div>}
            {mine.map(s=>(
              <div key={s.id} style={{display:'flex',gap:10,alignItems:'center',cursor:'pointer',padding:'8px 10px',borderRadius:12,background:'rgba(168,85,247,.05)'}} onClick={()=>onOpen(s)}>
                <img src={s.participants?.[0]?.photo||s.thumb||s.photo} style={{width:40,height:40,borderRadius:8,objectFit:'cover',flexShrink:0}} alt=""/>
                <div style={{flex:1,minWidth:0}}>
                  <div style={{fontSize:12,fontWeight:600,marginBottom:2,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{s.title}</div>
                  <div style={{fontSize:9,color:'var(--dim)'}}>{s.countries}개국 · {(s.totalKm/1000).toFixed(1)}K km</div>
                </div>
                <button onClick={e=>{e.stopPropagation();if(confirm('삭제할까요?'))onDelete&&onDelete(s.id);}} className="btn" style={{fontSize:18,lineHeight:1,color:'rgba(255,80,80,.5)',flexShrink:0,padding:'4px 8px'}}>×</button>
              </div>
            ))}
          </div>
        </div>

        {/* 참여한 릴레이 */}
        {joined.length>0&&(
          <div style={{padding:'16px 18px 0'}}>
            <div style={{fontSize:10,fontWeight:700,color:'var(--dim)',letterSpacing:'.08em',marginBottom:10}}>{t.join||'참여'}</div>
            <div style={{display:'flex',flexDirection:'column',gap:8}}>
              {joined.map(s=>(
                <div key={s.id} style={{display:'flex',gap:10,alignItems:'center',cursor:'pointer',padding:'8px 10px',borderRadius:12,background:'rgba(168,85,247,.05)'}} onClick={()=>onOpen(s)}>
                  <img src={s.participants?.[0]?.photo||s.thumb||s.photo} style={{width:40,height:40,borderRadius:8,objectFit:'cover',flexShrink:0}} alt=""/>
                  <div style={{flex:1,minWidth:0}}>
                    <div style={{fontSize:12,fontWeight:600,marginBottom:2,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{s.title}</div>
                    <div style={{fontSize:9,color:'var(--dim)'}}>{s.countries}개국 · {(s.totalKm/1000).toFixed(1)}K km</div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* 로그아웃 */}
        <div style={{padding:'24px 18px 40px'}}>
          <button onClick={onLogout} className="btn" style={{fontSize:11,color:'rgba(255,80,80,.4)'}}>로그아웃</button>
        </div>
      </div>

      {followListModal&&<FollowListModal title={followListModal.type==='followers'?'팔로워':'팔로잉'} list={followListModal.list} onClose={()=>setFollowListModal(null)}/>}
      {inboxOpen&&<InboxModal bubbles={bubbles} user={user} onClose={()=>setInboxOpen(false)} onReply={(b,type)=>setReplyModal({bubble:b,type})}/>}
      {replyModal&&<ReplyModal bubble={replyModal.bubble} replyType={replyModal.type} onClose={()=>setReplyModal(null)} onSend={handleReply}/>}
      {askModal&&<AskModal creator={askModal.target||user} onClose={()=>setAskModal(null)} onSend={(text)=>handleAsk(text,askModal.target||user)}/>}
    </div>
  );
};


const JoinRelay=({seed,user,onClose,onPublish})=>{
  const {t}=useT();
  const isNew=!seed;
  const [step,setStep]=useState(1);
  const [previewUrl,setPreviewUrl]=useState(null);
  const [previewLoading,setPreviewLoading]=useState(false);
  const [type,setType]=useState('portrait');
  const [isVideoFile,setIsVideoFile]=useState(false);
  const [title,setTitle]=useState(seed?seed.title:'');
  const [desc,setDesc]=useState('');
  const [locQuery,setLocQuery]=useState('');
  const [locResult,setLocResult]=useState(null);
  const [placeSuggestions,setPlaceSuggestions]=useState([]);
  const [placeSearching,setPlaceSearching]=useState(false);
  const [pct,setPct]=useState(0);
  const [uploading,setUploading]=useState(false);
  const fileRef=useRef(null);
  const locDebounceRef=useRef(null);

  const searchPlaces=async(q)=>{if(q.length<2){setPlaceSuggestions([]);return;}setPlaceSearching(true);try{const res=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=6`,{headers:{'Accept-Language':'ko,en'}});const data=await res.json();setPlaceSuggestions(data.map(p=>({name:p.display_name.split(',').slice(0,2).join(', '),mx:((parseFloat(p.lon)+180)/360),my:(1-(Math.log(Math.tan((parseFloat(p.lat)*Math.PI/180)/2+Math.PI/4))+Math.PI)/(2*Math.PI))})));}catch(e){setPlaceSuggestions([]);}setPlaceSearching(false);};
  const onLocInput=e=>{const v=e.target.value;setLocQuery(v);setLocResult(null);clearTimeout(locDebounceRef.current);locDebounceRef.current=setTimeout(()=>searchPlaces(v),400);};
  const onFile=e=>{const f=e.target.files[0];if(!f)return;setPreviewLoading(true);if(f.type.startsWith('video/')){const url=URL.createObjectURL(f);const v=document.createElement('video');v.src=url;v.onloadedmetadata=()=>{if(v.duration>60){alert('Max 60s');URL.revokeObjectURL(url);return;}setType(v.videoWidth>v.videoHeight?'landscape':'portrait');setIsVideoFile(true);setPreviewUrl(url);setPreviewLoading(false);setStep(2);};}else if(f.type.startsWith('image/')){const url=URL.createObjectURL(f);setIsVideoFile(false);setPreviewUrl(url);setPreviewLoading(false);setStep(2);}};
  const publish=async()=>{
    if(isNew&&!title)return;
    setUploading(true);
    // blob URL → base64 변환 (영구 저장용)
    let mediaData=previewUrl||'https://images.unsplash.com/photo-1501854140801-50d01698950b?w=800';
    if(previewUrl&&previewUrl.startsWith('blob:')){
      try{
        const res=await fetch(previewUrl);
        const blob=await res.blob();
        mediaData=await new Promise((ok,err)=>{const r=new FileReader();r.onload=()=>ok(r.result);r.onerror=err;r.readAsDataURL(blob);});
      }catch(e){console.log('media convert error',e);}
    }
    const _start=Date.now();
    const _run=()=>{const p=Math.min((Date.now()-_start)/600*100,100);setPct(p);
      if(p<100){requestAnimationFrame(_run);}else{
        if(isNew){onPublish({id:'s'+Date.now(),uid:user.uid||user.id,name:user.name,handle:user.handle||'@user',avatar:user.avatar,cat:'',title,thumb:mediaData,totalKm:0,honors:0,countries:1,type,isVideo:isVideoFile,comments:[],participants:[{id:'p1',name:user.name,handle:user.handle||'@user',avatar:user.avatar,city:(locResult?locResult.name:'Seoul'),loc:(locResult||LOC.seoul),km:0,photo:mediaData,isVideo:isVideoFile,desc}]});}
        else{onPublish(seed.id,{id:'p'+Date.now(),name:user.name,handle:user.handle||'@user',avatar:user.avatar,city:(locResult?locResult.name:'Seoul'),loc:(locResult||LOC.seoul),km:Math.floor(Math.random()*15000+500),photo:mediaData,isVideo:isVideoFile,desc});}
        setStep(3);}};
    requestAnimationFrame(_run);};
  if(step===3)return(
    <div style={{position:'absolute',inset:0,zIndex:88,background:'#08000f',display:'flex',flexDirection:'column',justifyContent:'center',alignItems:'center',padding:'0 36px',textAlign:'center'}} className="af">
      <div style={{width:52,height:52,borderRadius:99,background:'linear-gradient(135deg,#7c3aed,#ec4899)',display:'flex',alignItems:'center',justifyContent:'center',marginBottom:20,fontSize:22,color:'#fff'}}>✓</div>
      <div style={{fontSize:16,fontWeight:800,marginBottom:8,background:'linear-gradient(135deg,#a855f7,#f472b6)',WebkitBackgroundClip:'text',WebkitTextFillColor:'transparent',backgroundClip:'text'}}>
        {isNew?t.relayStarted:t.joinDone}
      </div>
      <p style={{fontSize:12,color:'var(--dim)',lineHeight:1.65,marginBottom:32}}>
        {isNew?t.relayStartedDesc:(seed.title+' '+t.joinedRelay)}
      </p>
      <button onClick={onClose} className="gbtn" style={{padding:'12px 28px',borderRadius:12,fontSize:13}}>{t.goHome}</button>
    </div>
  );
  return(
    <div style={{position:'absolute',inset:0,zIndex:88,background:'#08000f',display:'flex',flexDirection:'column',overflow:'hidden'}} className="af">
      <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'16px 18px',flexShrink:0,borderBottom:'1px solid rgba(168,85,247,.1)'}}>
        <div>
          <div style={{fontSize:13,fontWeight:700}}>{isNew?t.newRelay:t.joining}</div>
          {!isNew&&<div style={{fontSize:9,color:'var(--p)',marginTop:1}}>{seed.title}</div>}
        </div>
        <button onClick={onClose} className="btn" style={{fontSize:24,color:'var(--dim)'}}>×</button>
      </div>
      {step===1&&<div style={{flex:1,display:'flex',flexDirection:'column',justifyContent:'center',padding:'0 36px',gap:16}}><input ref={fileRef} type="file" accept="video/*,image/*" style={{display:'none'}} onChange={onFile}/>
        {previewLoading?<div style={{display:'flex',flexDirection:'column',alignItems:'center',gap:12,padding:'20px 0'}}>
          <div style={{width:44,height:44,borderRadius:99,border:'3px solid rgba(168,85,247,.25)',borderTopColor:'#a855f7',animation:'spin 1s linear infinite'}}/>
          <div style={{fontSize:11,color:'var(--dim)'}}>파일 불러오는 중…</div>
        </div>:<>
          <div style={{display:'flex',flexDirection:'column',alignItems:'center',gap:16,padding:'20px 0',cursor:'pointer'}} onClick={()=>fileRef.current?.click()}>
            <div style={{width:80,height:80,borderRadius:99,border:'2px dashed rgba(168,85,247,.4)',display:'flex',alignItems:'center',justifyContent:'center',background:'rgba(168,85,247,.06)'}}>
              <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="rgba(168,85,247,.7)" strokeWidth="1.5"><rect x="2" y="3" width="20" height="18" rx="2"/><path d="M16 8l4-4v16l-4-4"/><circle cx="9" cy="12" r="3"/></svg>
            </div>
            <div style={{textAlign:'center'}}>
              <div style={{fontSize:13,fontWeight:600,marginBottom:4}}>{t.selectVideo}</div>
              <div style={{fontSize:10,color:'var(--dim)',lineHeight:1.6}}>{t.uploadDesc}</div>
            </div>
          </div>
        </>}
      </div>}
      {step===2&&(<>
        <div className="sc" style={{flex:1,padding:'0 18px'}}>
          {previewUrl&&<div style={{borderRadius:12,overflow:'hidden',marginBottom:16,background:'#0d0018',aspectRatio:type==='landscape'?'16/9':'9/16',maxHeight:200}}><video src={previewUrl} style={{width:'100%',height:'100%',objectFit:'cover'}} controls muted playsInline/></div>}
          {uploading?(<div style={{padding:'20px 0'}}><div style={{fontSize:11,marginBottom:8}}>{t.uploading}</div><div style={{height:2,background:'rgba(255,255,255,.08)',borderRadius:99,overflow:'hidden'}}><div style={{height:'100%',background:'linear-gradient(90deg,#7c3aed,#ec4899)',width:`${pct}%`,transition:'width .2s',borderRadius:99}}/></div></div>):(
            <div style={{display:'flex',flexDirection:'column',gap:4}}>
              {isNew&&<input className="inp" placeholder={t.title} value={title} onChange={e=>setTitle(e.target.value)}/>}
              <textarea className="inp" style={{height:52,marginTop:4}} placeholder={t.descTxt} value={desc} onChange={e=>setDesc(e.target.value)}/>
              <div style={{position:'relative',marginTop:4}}>
                <input className="inp" placeholder="📍 장소·가게 검색 (예: 홍대 카페, Eiffel Tower…)"
                  value={locResult?locResult.name:locQuery} onChange={onLocInput}/>
                {placeSearching&&<div style={{position:'absolute',right:10,top:'50%',transform:'translateY(-50%)',fontSize:9,color:'var(--dim)',pointerEvents:'none'}}>검색중…</div>}
                {placeSuggestions.length>0&&!locResult&&(
                  <div style={{position:'absolute',top:'100%',left:0,right:0,zIndex:50,background:'#0d0018',border:'1px solid rgba(168,85,247,.25)',borderRadius:8,overflow:'hidden',maxHeight:160,overflowY:'auto'}}>
                    {placeSuggestions.map((l,i)=>(
                      <div key={i} onClick={()=>{setLocResult(l);setLocQuery('');setPlaceSuggestions([]);}}
                        style={{padding:'9px 12px',fontSize:11,cursor:'pointer',borderBottom:'1px solid rgba(168,85,247,.07)',lineHeight:1.4}}>
                        <div style={{fontWeight:500}}>{l.name.split(',')[0]}</div>
                        <div style={{fontSize:9,color:'var(--dim)',marginTop:1,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{l.name}</div>
                      </div>
                    ))}
                  </div>
                )}
              </div>
              
            </div>
          )}
        </div>
        {!uploading&&<div style={{padding:'12px 18px',borderTop:'1px solid rgba(168,85,247,.1)',flexShrink:0,display:'flex',justifyContent:'space-between',alignItems:'center'}}><button onClick={()=>setStep(1)} className="btn" style={{fontSize:11,color:'var(--dim)'}}>{t.prevStep}</button><button onClick={publish} className="gbtn" style={{padding:'10px 22px',borderRadius:10,fontSize:12}}>{isNew?t.startRelay:t.join+' →'}</button></div>}
      </>)}
    </div>
  );
};

/* ═══ LOGIN ═══ */
const Login=({onLogin})=>{
  const {t,lang,setLang}=useT();
  const [mode,setMode]=useState('login');
  const [name,setName]=useState('');
  const [email,setEmail]=useState('');
  const [pw,setPw]=useState('');
  const [err,setErr]=useState('');
  const [loading,setLoading]=useState(false);

  const go=async()=>{
    setErr('');
    if(mode==='login'){
      if(!email||!pw)return setErr(t.errEmpty);
      setLoading(true);
      try{
        if(!window.FB){throw {code:'no-firebase'};}
        const cred=await window.FB.signInWithEmailAndPassword(window.FB.auth,email,pw);
        const snap=await window.FB.getDoc(window.FB.doc(window.FB.db,'users',cred.user.uid));
        if(snap.exists()){
          onLogin({...snap.data(), uid: cred.user.uid});
        } else {
          onLogin({id:cred.user.uid,uid:cred.user.uid,name:email.split('@')[0],handle:'@'+email.split('@')[0],email,bio:'',avatar:`https://i.pravatar.cc/80?img=${Math.floor(Math.random()*40+1)}`,followers:0,totalKm:0});
        }
      }catch(e){
        const code=e.code||'';
        if(code==='auth/user-not-found'||code==='auth/wrong-password'||code==='auth/invalid-credential')setErr('이메일 또는 비밀번호가 올바르지 않아요');
        else if(code==='auth/too-many-requests')setErr('잠시 후 다시 시도해주세요');
        else if(code==='no-firebase')setErr('연결 중입니다. 잠시 후 다시 시도해주세요');
        else setErr('로그인에 실패했어요: '+code);
        setLoading(false);
      }
    } else {
      if(!name||!email||!pw)return setErr(t.errAll);
      if(pw.length<6)return setErr(t.errPw);
      setLoading(true);
      try{
        const cred=await window.FB.createUserWithEmailAndPassword(window.FB.auth,email,pw);
        const userData={
          id:cred.user.uid, uid:cred.user.uid,
          name, email,
          handle:'@'+name.toLowerCase().replace(/\s+/g,''),
          bio:'', avatar:`https://i.pravatar.cc/80?img=${Math.floor(Math.random()*40+1)}`,
          followers:0, totalKm:0,
          createdAt: window.FB.serverTimestamp(),
          country: navigator.language||'unknown'
        };
        await window.FB.setDoc(window.FB.doc(window.FB.db,'users',cred.user.uid), userData);
        window.FB.logEvent(window.FB.analytics,'sign_up',{method:'email'});
        onLogin(userData);
      }catch(e){
        const code2=e.code||'';
        if(code2==='auth/email-already-in-use')setErr('이미 사용 중인 이메일이에요');
        else if(code2==='auth/weak-password')setErr('비밀번호는 6자 이상이어야 해요');
        else setErr('회원가입 실패: '+code2);
        setLoading(false);
      }
    }
  };

  return(
    <div className="sc" style={{flex:1,display:'flex',flexDirection:'column',justifyContent:'center',padding:'0 36px'}}>
      <div className="au" style={{marginBottom:44,textAlign:'center'}}>
        <div style={{fontSize:42,fontWeight:900,letterSpacing:-2,background:'linear-gradient(135deg,#a855f7,#f472b6)',WebkitBackgroundClip:'text',WebkitTextFillColor:'transparent',backgroundClip:'text',marginBottom:4}}>Kmilo</div>
        <div style={{fontSize:10,letterSpacing:'.22em',color:'rgba(168,85,247,.5)'}}>GLOBAL RELAY</div>
      </div>
      <div style={{display:'flex',justifyContent:'center',gap:16,marginBottom:28}}>
        {[['ko','한'],['en','EN'],['ja','JP']].map(([l,label])=>(
          <button key={l} onClick={()=>setLang(l)} className="btn"
            style={{fontSize:11,fontWeight:lang===l?700:400,color:lang===l?'var(--p)':'var(--dim)',borderBottom:lang===l?'1px solid var(--p)':'none',paddingBottom:2}}>{label}</button>
        ))}
      </div>
      <div style={{display:'flex',marginBottom:24,borderBottom:'1px solid rgba(168,85,247,.15)'}}>
        {[['login',t.login],['signup',t.signup]].map(([m,label])=>(
          <button key={m} onClick={()=>{setMode(m);setErr('');}} className="btn"
            style={{flex:1,paddingBottom:10,fontSize:13,fontWeight:mode===m?700:400,color:mode===m?'#fff':'var(--dim)',borderBottom:mode===m?'2px solid var(--p)':'2px solid transparent'}}>{label}</button>
        ))}
      </div>
      {mode==='signup'&&<input className="inp" placeholder={t.name||'이름'} value={name} onChange={e=>setName(e.target.value)} style={{marginBottom:12}}/>}
      <input className="inp" placeholder={t.email} value={email} onChange={e=>setEmail(e.target.value)} style={{marginBottom:12}}/>
      <input className="inp" type="password" placeholder={t.pw} value={pw} onChange={e=>setPw(e.target.value)} style={{marginBottom:err?8:20}} onKeyDown={e=>e.key==='Enter'&&go()}/>
      {err&&<div style={{fontSize:11,color:'#f472b6',marginBottom:12}}>{err}</div>}
      <button onClick={go} className="gbtn" style={{padding:'14px',borderRadius:14,fontSize:14,fontWeight:700}} disabled={loading}>
        {loading?t.loading:mode==='login'?t.loginBtn:t.signupBtn}
      </button>

    </div>
  );
};


const Notifs=({onClose})=>{
  const {t}=useT();
  return(
    <div style={{position:'absolute',inset:0,zIndex:80,background:'rgba(8,0,15,.92)',display:'flex',flexDirection:'column',justifyContent:'flex-end'}} onClick={e=>{if(e.target===e.currentTarget)onClose();}}>
      <div style={{background:'#0d0018',borderTop:'1px solid rgba(168,85,247,.15)',maxHeight:'62%',display:'flex',flexDirection:'column'}} className="asu">
        <div style={{display:'flex',justifyContent:'space-between',padding:'16px 18px 12px',flexShrink:0}}>
          <div style={{fontSize:10,color:'var(--p)',letterSpacing:'.08em'}}>{t.notifTitle.toUpperCase()}</div>
          <button onClick={onClose} className="btn" style={{fontSize:11,color:'var(--dim)'}}>{t.close}</button>
        </div>
        <div className="sc" style={{flex:1,padding:'0 18px 20px'}}>
          {NOTIFS.map(n=>(
            <div key={n.id} style={{padding:'11px 0',borderBottom:'1px solid rgba(168,85,247,.07)',opacity:n.read?.38:1}}>
              <div style={{fontSize:12,lineHeight:1.5,marginBottom:2}}>{n.text}</div>
              {n.sub&&<div style={{fontSize:10,color:'var(--p)',marginBottom:2}}>"{n.sub}"</div>}
              <div style={{fontSize:9,color:'var(--dim)'}}>{n.time}</div>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
};

/* ═══ APP ═══ */
const App=()=>{
  const {t}=useT();
  const [user,setUser]=useState(null);
  const [authChecked,setAuthChecked]=useState(false);
  const [seeds,setSeeds]=useState(SEEDS);
  const [tab,setTab]=useState('home');
  const [detail,setDetail]=useState(null);
  const [joinModal,setJoinModal]=useState(null);
  const [notif,setNotif]=useState(false);
  const [askTarget,setAskTarget]=useState(null);

  const unread=NOTIFS.filter(n=>!n.read).length;

  // Firebase Auth 상태 감지
  useEffect(()=>{
    const waitFB=()=>{
      if(!window.FB){setTimeout(waitFB,100);return;}
      window.FB.onAuthStateChanged(window.FB.auth, async(fbUser)=>{
        if(fbUser){
          try{
            const snap=await window.FB.getDoc(window.FB.doc(window.FB.db,'users',fbUser.uid));
            if(snap.exists()) setUser({...snap.data(),uid:fbUser.uid});
            else setUser({id:fbUser.uid,uid:fbUser.uid,name:fbUser.email.split('@')[0],handle:'@'+fbUser.email.split('@')[0],email:fbUser.email,bio:'',avatar:`https://i.pravatar.cc/80?img=1`,followers:0,totalKm:0});
          }catch(e){ setUser(null); }
        } else { setUser(null); }
        setAuthChecked(true);
      });
    };
    waitFB();
  },[]);

  // Firestore에서 릴레이 데이터 실시간 로드
  useEffect(()=>{
    if(!user||!window.FB)return;
    try{
      const q=window.FB.query(window.FB.collection(window.FB.db,'relays'),window.FB.orderBy('createdAt','desc'));
      const unsub=window.FB.onSnapshot(q, snap=>{
        const fbSeeds=snap.docs.map(d=>({...d.data(),id:d.id}));
        setSeeds(fbSeeds.length>0?[...fbSeeds,...SEEDS]:SEEDS);
      });
      return ()=>unsub();
    }catch(e){ console.log('Firestore load error:',e); }
  },[user]);

  const handleLogin=(u)=>{
    setUser(u);
    if(window.FB) window.FB.logEvent(window.FB.analytics,'login',{method:'email'});
  };

  const handleLogout=async()=>{
    if(window.FB) await window.FB.signOut(window.FB.auth);
    setUser(null);
    setTab('home');
  };

  const handlePublish=async(sidOrObj,part)=>{
    if(!part){
      // 새 릴레이
      const newSeed={...sidOrObj, createdAt: window.FB?window.FB.serverTimestamp():Date.now(), uid: user?.uid||'', authorUid: user?.uid||''};
      if(window.FB){
        try{
          const docRef=await window.FB.addDoc(window.FB.collection(window.FB.db,'relays'),newSeed);
          setSeeds(p=>[{...newSeed,id:docRef.id},...p]);
          window.FB.logEvent(window.FB.analytics,'relay_created',{category:newSeed.cat||'unknown',type:newSeed.type||'portrait'});
        }catch(e){ setSeeds(p=>[sidOrObj,...p]); }
      } else { setSeeds(p=>[sidOrObj,...p]); }
    } else {
      // 기존 릴레이 참여
      setSeeds(p=>p.map(s=>s.id===sidOrObj?{...s,participants:[...s.participants,part],countries:s.countries+1,totalKm:s.totalKm+part.km}:s));
      if(window.FB){
        try{
          const s=seeds.find(s=>s.id===sidOrObj);
          if(s){
            await window.FB.updateDoc(window.FB.doc(window.FB.db,'relays',sidOrObj),{
              participants:[...s.participants,part],
              countries:s.countries+1,
              totalKm:s.totalKm+part.km
            });
            window.FB.logEvent(window.FB.analytics,'relay_joined',{relay_id:sidOrObj,relay_title:s.title||'unknown',category:s.cat||'unknown'});
          }
        }catch(e){ console.log('update error:',e); }
      }
    }
    setJoinModal(null);
  };

  const handleDelete=async(id)=>{
    setSeeds(p=>p.filter(s=>s.id!==id));
    if(window.FB){
      try{ await window.FB.deleteDoc(window.FB.doc(window.FB.db,'relays',id)); }catch(e){}
    }
  };

  // 버블 전송 (전역)
  const handleSendBubble=async(text,targetUser)=>{
    if(!targetUser||!text.trim())return;
    const bubble={
      creatorHandle:targetUser.handle,
      creatorUid:targetUser.uid||targetUser.id||'',
      creator:{name:targetUser.name,handle:targetUser.handle,avatar:targetUser.avatar},
      question:text,
      askerName:'익명',
      askerUid:user?.uid||'',
      answers:[],
      publicAnswer:null,
      createdAt:window.FB?window.FB.serverTimestamp():Date.now(),
      expiresAt:Date.now()+86400000,
    };
    if(window.FB){
      try{
        await window.FB.addDoc(window.FB.collection(window.FB.db,'bubbles'),bubble);
      }catch(e){console.log('bubble error:',e);}
    }
    setAskTarget(null);
  };

  // 체류 시간 추적
  const pageEnterRef=useRef(null);
  const openDetail=(seed)=>{
    pageEnterRef.current={seed,time:Date.now()};
    setDetail(seed);
  };
  const closeDetail=()=>{
    if(pageEnterRef.current&&window.FB){
      const sec=Math.round((Date.now()-pageEnterRef.current.time)/1000);
      window.FB.logEvent(window.FB.analytics,'relay_view_time',{
        relay_id:pageEnterRef.current.seed.id,
        relay_title:pageEnterRef.current.seed.title||'unknown',
        seconds:sec
      });
    }
    pageEnterRef.current=null;
    setDetail(null);
  };

  if(!authChecked) return(
    <div style={{flex:1,display:'flex',alignItems:'center',justifyContent:'center',flexDirection:'column',gap:12}}>
      <div style={{width:40,height:40,borderRadius:99,border:'3px solid rgba(168,85,247,.2)',borderTopColor:'#a855f7',animation:'spin 1s linear infinite'}}/>
      <div style={{fontSize:11,color:'var(--dim)'}}>Kmilo</div>
    </div>
  );

  const TABS=[{key:'home',label:t.home},{key:'explore',label:t.tab_explore||'탐색'},{key:'new',label:'+'},{key:'legacy',label:t.legacy},{key:'profile',label:t.profile}];

  const {lang:_l,t:_t,setLang:_sl}=useContext(LangCtx);
  return(
    <>
      {!user&&<Login onLogin={handleLogin}/>}
      {user&&joinModal!==null&&<JoinRelay seed={joinModal||null} user={user} onClose={()=>setJoinModal(null)} onPublish={handlePublish}/>}
      {user&&joinModal===null&&detail&&<SeedDetail seed={detail} onBack={closeDetail} currentUser={user} onDelete={handleDelete} onAsk={u=>setAskTarget(u)}/>}
      {user&&joinModal===null&&!detail&&(<>
        {tab==='home'&&<HomeFeed seeds={seeds} onDetail={openDetail} onNotif={()=>setNotif(true)} unread={unread} onJoin={s=>setJoinModal(s)} currentUser={user} onAsk={setAskTarget}/>}
        {tab==='explore'&&<Explore seeds={seeds} onOpen={openDetail} onJoin={s=>setJoinModal(s)} currentUser={user}/>}
        {tab==='legacy'&&<Legacy user={user} seeds={seeds} onOpen={openDetail} onAsk={u=>setAskTarget(u)}/>}
        {tab==='profile'&&<Profile user={user} seeds={seeds} onLogout={handleLogout} onOpen={openDetail} onDelete={handleDelete} onUpdateUser={u=>{setUser(u);if(window.FB)window.FB.updateDoc(window.FB.doc(window.FB.db,'users',u.uid),{avatar:u.avatar}).catch(()=>{});}}/>}
        {notif&&<Notifs onClose={()=>setNotif(false)}/>}
        {askTarget&&<AskModal creator={askTarget} onClose={()=>setAskTarget(null)} onSend={(text)=>handleSendBubble(text,askTarget)}/>}
        {askTarget&&<AskModal creator={askTarget} onClose={()=>setAskTarget(null)} onSend={(msg)=>{alert('버블을 보냈어요! 💬');setAskTarget(null);}}/>}
        <div className="tabbar">
          {TABS.map(({key,label})=>(
            <button key={key} onClick={()=>{if(key==='new'){setJoinModal(false);}else{if(window.FB)window.FB.logEvent(window.FB.analytics,'tab_view',{tab_name:key});setTab(key);}}} className="btn"
              style={{flex:1,flexDirection:'column',gap:1,fontSize:9,fontWeight:600,color:key==='new'?'transparent':tab===key?'var(--p)':'rgba(255,255,255,.22)'}}>
              {key==='new'?<div className="fab" style={{marginTop:-18}}>+</div>:<span className={`kmn kmn-${key}`}/>}
              {key!=='new'&&<span>{label}</span>}
            </button>
          ))}
        </div>
      </>)}
    </>
  );
};


const Root=()=>{
  const [lang,setLang]=useState(()=>{
    try{return localStorage.getItem('kmilo_lang')||navigator.language.split('-')[0]||'ko';}catch(e){return 'ko';}
  });
  const t=LANGS[lang]||LANGS.ko;
  const ctx={lang,t,setLang:(l)=>{setLang(l);try{localStorage.setItem('kmilo_lang',l);}catch(e){};}};
  return(
    <LangCtx.Provider value={ctx}>
      <div className="phone" style={{display:'flex',flexDirection:'column',position:'relative'}}>
        <App/>
      </div>
    </LangCtx.Provider>
  );
};
ReactDOM.createRoot(document.getElementById('root')).render(<Root/>);
</script>
</body>
</html>